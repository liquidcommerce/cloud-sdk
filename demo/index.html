<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiquidCommerce SDK Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      padding-top: 80px;
      padding-bottom: 60px;
      background-color: #f8f9fa;
      margin: 0;
    }

    .navbar-area, .footer-top {
      background-color: #101B2C;
      position: fixed;
      left: 0;
      right: 0;
      z-index: 1030;
    }

    .navbar-area {
      top: 0;
      height: 80px;
      display: flex;
      align-items: center;
    }

    .footer-top {
      bottom: 0;
      height: 60px;
      color: white;
      display: flex;
      align-items: center;
    }

    .navbar-brand img, .footer-logo img {
      height: 40px;
      width: auto;
      max-width: 250px;
    }

    .container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
    }

    #hero-area {
      min-height: calc(100vh - 140px);
      display: flex;
      align-items: center;
    }

    #addressInput {
      width: 100%;
      padding: 10px;
      margin-bottom: 5px;
    }

    #autocompleteResults {
      list-style-type: none;
      padding: 0;
      margin: 0;
      background-color: white;
      border: 1px solid #ddd;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
    }

    #autocompleteResults li {
      padding: 10px;
      cursor: pointer;
    }

    #autocompleteResults li:hover {
      background-color: #f0f0f0;
    }

    #results, #availabilityResults, #catalogResults {
      background: #ffffff;
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .footer-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .nav-tabs {
      border-bottom: none;
      margin-left: auto;
      display: none !important; /* Always hide the nav-tabs forcefully */
      justify-content: flex-end;
      align-items: center;
    }

    .nav-tabs .nav-item {
      margin-left: 20px;
    }

    .nav-tabs .nav-link {
      color: #ffffff;
      border: none;
      padding: 10px 15px;
      transition: all 0.3s ease;
    }

    .nav-tabs .nav-link.active,
    .nav-tabs .nav-link:hover {
      color: #7ebcff;
      background-color: transparent;
      border-bottom: 2px solid #7ebcff;
    }

    .catalog-form {
      background-color: #f8f9fa;
      border-radius: 5px;
      margin-bottom: 20px;
      padding: 20px;
    }

    .catalog-form h3 {
      margin-bottom: 15px;
    }

    .catalog-section {
      margin-bottom: 30px;
    }

    .card {
      transition: box-shadow 0.3s ease-in-out;
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 100%;
    }

    .card:hover {
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .availability-product {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      border-bottom: 1px solid #ddd;
    }

    .availability-product-image {
      height: 220px;
      object-fit: cover;
    }

    .card-img-top {
      height: 200px;
      object-fit: cover;
      border-top-left-radius: calc(0.375rem - 1px);
      border-top-right-radius: calc(0.375rem - 1px);
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .card-text {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .list-group-item {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    .card-footer {
      background-color: #f8f9fa;
      border-top: none;
    }

    .navbar-toggler {
      display: none;
      padding: 0.25rem;
      font-size: 1rem;
      background-color: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.25rem;
      transition: box-shadow 0.15s ease-in-out;
      display: block !important; /* Ensure navbar-toggler is always visible */
    }

    .navbar-toggler-icon {
      display: inline-block;
      width: 1.5em;
      height: 1.5em;
      vertical-align: middle;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.55%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 100%;
    }

    .navbar-toggler:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .navbar-toggler:focus {
      outline: 0;
      box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
    }

    .offcanvas-header {
      border-bottom: 1px solid #dee2e6;
    }

    .offcanvas-body {
      padding: 1rem;
    }

    .offcanvas-body .nav-link {
      display: block;
      width: 100%;
      text-align: left;
      padding: 0.75rem 1rem;
      margin: 0.125rem 0;
      border: none;
      border-radius: 0.25rem;
      background-color: #f8f9fa;
      color: #333;
      transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
    }

    .offcanvas-body .nav-link:hover,
    .offcanvas-body .nav-link:focus {
      background-color: #e2e6ea;
      color: #000;
      text-decoration: none;
    }

    .offcanvas-body .nav-link.active {
      background-color: #007bff;
      color: #fff;
    }

    .session-result {
      background-color: #f4f4f9;
      border: 1px solid #dcdcdc;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }

    .session-result h4, .session-result h5 {
      color: #333;
    }

    .session-result p, .session-result li {
      color: #777;
      font-size: 14px;
      line-height: 1.6;
    }

    .session-result img {
      border-radius: 50%;
    }

    .session-result ul {
      list-style-type: none;
      padding: 0;
    }

    .session-result li {
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 10px;
    }

    .session-detail {
      font-family: monospace;
      background-color: #f9f9f9;
      border-left: 4px solid #007bff;
      padding: 10px;
      margin-bottom: 10px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }

    .session-detail strong {
      color: #333;
    }

    .section-container {
      max-width: auto;
      margin: 0 auto;
      padding: 2rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 1.8rem;
      color: #333;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .payment-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 0.25rem;
    }

    .form-input {
      padding: 0.75rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }

    .btn {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
    }

    .btn-primary {
      background-color: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #545b62;
    }

    .btn-warning {
      background-color: #ffc107;
      color: #212529;
    }

    .btn-warning:hover {
      background-color: #e0a800;
    }

    .btn-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background-color: #c82333;
    }

    .payment-element-container {
      margin-top: 1.5rem;
      min-height: 100px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 1rem;
    }

    .payment-token-result {
      margin-top: 1.5rem;
      padding: 1rem;
      background-color: #e9ecef;
      border-radius: 4px;
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .button-group .btn {
      width: 100%;
    }

    @media (max-width: 1200px) {
      .nav-tabs .nav-item {
        margin-left: 15px;
      }
    }

    @media (max-width: 992px) {
      .section-title {
        font-size: 1.6rem;
      }
      /* .navbar-toggler {
        display: block;
      } */ /* This is now handled globally */
    }

    @media (max-width: 768px) {
      .section-container {
        padding: 1rem;
      }

      .section-title {
        font-size: 1.4rem;
      }

      .button-group {
        grid-template-columns: 1fr;
      }

      .btn {
        width: 100%;
      }

      .availability-product {
        display: flex;
        flex-direction: column;
        text-align: center;
      }

    }

    /* @media (min-width: 992px) {
      #offcanvasTabs {
        display: none !important;
      }
    } */ /* Comment out or remove this block to ensure offcanvas is always available */

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-dialog {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
    }

    .show {
      display: block;
    }
  </style>
</head>
<body>

<header class="navbar-area">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center w-100">
      <a href="index.html" class="navbar-brand">
        <img src="https://assets.liquidcommerce.co/development/cloud-sdk-logo.svg" style="max-width: 250px;" alt="Logo">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasTabs"
              aria-controls="offcanvasTabs" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Original Tabs (visible on larger screens) -->
      <ul class="nav nav-tabs" id="sdkTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="address-tab" data-bs-toggle="tab" data-bs-target="#address" type="button" role="tab"
                  aria-controls="address" aria-selected="true">Address
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="catalog-tab" data-bs-toggle="tab" data-bs-target="#catalog" type="button" role="tab"
                  aria-controls="catalog" aria-selected="false">Catalog
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="cart-tab" data-bs-toggle="tab" data-bs-target="#cart" type="button" role="tab" aria-controls="cart"
                  aria-selected="false">Cart
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="user-tab" data-bs-toggle="tab" data-bs-target="#user" type="button" role="tab"
                  aria-controls="user" aria-selected="false">User
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="payment-session-tab" data-bs-toggle="tab" data-bs-target="#payment-session" type="button" role="tab"
                  aria-controls="payment-session" aria-selected="false">Payment Session
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="payment-tab" data-bs-toggle="tab" data-bs-target="#payment" type="button" role="tab"
                  aria-controls="payment" aria-selected="false">Payment
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="checkout-tab" data-bs-toggle="tab" data-bs-target="#checkout" type="button" role="tab"
                  aria-controls="checkout" aria-selected="false">Checkout
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="order-tab" data-bs-toggle="tab" data-bs-target="#order" type="button" role="tab"
                  aria-controls="order" aria-selected="false">Order
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="webhook-tab" data-bs-toggle="tab" data-bs-target="#webhook" type="button" role="tab"
                  aria-controls="webhook" aria-selected="false">Webhook
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="auth-tab" data-bs-toggle="tab" data-bs-target="#auth" type="button" role="tab"
                  aria-controls="auth" aria-selected="false">Auth
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="payment-element-v2-tab" data-bs-toggle="tab" data-bs-target="#payment-element-v2" type="button" role="tab"
                  aria-controls="payment-element-v2" aria-selected="false">Payment Element V2
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Off-Canvas Menu -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasTabs" aria-labelledby="offcanvasTabsLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasTabsLabel">Menu</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column" id="menu-tabs">
        <li class="nav-item">
          <button class="nav-link active" id="address-tab-mobile" data-bs-toggle="tab" data-bs-target="#address" type="button" role="tab"
                  aria-controls="address" aria-selected="true">Address
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="catalog-tab-mobile" data-bs-toggle="tab" data-bs-target="#catalog" type="button" role="tab"
                  aria-controls="catalog" aria-selected="false">Catalog
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="cart-tab-mobile" data-bs-toggle="tab" data-bs-target="#cart" type="button" role="tab"
                  aria-controls="cart" aria-selected="false">Cart
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="user-tab-mobile" data-bs-toggle="tab" data-bs-target="#user" type="button" role="tab"
                  aria-controls="user" aria-selected="false">User
          </button>
        </li>
         <li class="nav-item">
          <button class="nav-link" id="payment-session-tab-mobile" data-bs-toggle="tab" data-bs-target="#payment-session" type="button" role="tab"
                  aria-controls="payment-session" aria-selected="false">Payment Session
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="payment-tab-mobile" data-bs-toggle="tab" data-bs-target="#payment" type="button" role="tab"
                  aria-controls="payment" aria-selected="false">Payment
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="checkout-tab-mobile" data-bs-toggle="tab" data-bs-target="#checkout" type="button" role="tab"
                  aria-controls="checkout" aria-selected="false">Checkout
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="order-tab-mobile" data-bs-toggle="tab" data-bs-target="#order" type="button" role="tab"
                  aria-controls="order" aria-selected="false">Order
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="webhook-tab-mobile" data-bs-toggle="tab" data-bs-target="#webhook" type="button" role="tab"
                  aria-controls="webhook" aria-selected="false">Webhook
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="auth-tab-mobile" data-bs-toggle="tab" data-bs-target="#auth" type="button" role="tab"
                  aria-controls="auth" aria-selected="false">Auth
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="payment-element-v2-tab-mobile" data-bs-toggle="tab" data-bs-target="#payment-element-v2" type="button" role="tab"
                  aria-controls="payment-element-v2" aria-selected="false">Payment Element V2
          </button>
        </li>
      </ul>
    </div>
  </div>
  </div>
</header>

<main id="hero-area" role="main">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="tab-content" id="sdkTabsContent" style="padding: 20px;">

          <!-- ADDRESS SEARCH & DETAILS EXAMPLE -->
          <div class="tab-pane fade show active" id="address" role="tabpanel" aria-labelledby="address-tab">
            <div class="section-container">
              <h2 class="section-title mb-3">Search Addresses</h3>
                <input type="text" id="addressInput" class="form-control" placeholder="Enter address (min 3 characters)">
                <ul id="autocompleteResults"></ul>
                <div id="results"></div>
            </div>
          </div>

          <!-- CATALOG AVAILABILITY EXAMPLE -->
          <div id="catalog" class="tab-pane fade" role="tabpanel" aria-labelledby="catalog-tab">
            <div class="section-container">
              <div class="catalog-section">
                <div id="catalogAvailabilityForm" class="catalog-form">
                  <h2 class="section-title">Check Product Availability</h2>
                  <form id="availabilityForm">
                    <div class="mb-3">
                      <label for="upcs" class="form-label">UPCs (comma-separated)</label>
                      <input type="text" class="form-control" id="upcs" required>
                    </div>
                    <div class="mb-3">
                      <label for="zipCode" class="form-label">Zip Code</label>
                      <input type="text" class="form-control" id="zipCode" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Check Availability</button>
                  </form>
                </div>
                <div id="availabilityResults"></div>
              </div>
              <hr>

              <div class="catalog-section">
                <div id="catalogSearchForm" class="catalog-form">
                  <h2 class="section-title">Search Products</h2>
                  <form id="searchForm">
                    <div class="mb-3">
                      <label for="searchQuery" class="form-label">Search Query</label>
                      <input type="text" class="form-control" id="searchQuery">
                    </div>
                    <div class="mb-3">
                      <label for="searchZipCode" class="form-label">Zip Code</label>
                      <input type="text" class="form-control" id="searchZipCode">
                    </div>
                    <div class="mb-3">
                      <label for="priceRange" class="form-label">Price Range</label>
                      <select class="form-select" id="priceRange">
                        <option value="">All Prices</option>
                        <option value="0-50">$0 - $50</option>
                        <option value="50-100">$50 - $100</option>
                        <option value="100-200">$100 - $200</option>
                        <option value="200+">$200+</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="category" class="form-label">Category</label>
                      <select class="form-select" id="category">
                        <option value="">All Categories</option>
                        <option value="SPIRITS > TEQUILA">TEQUILA</option>
                        <option value="SPIRITS > GIN">GIN</option>
                        <option value="SPIRITS > WHISKEY">WHISKEY</option>
                        <option value="WINE > CHAMPAGNE & SPARKLING">CHAMPAGNE & SPARKLING</option>
                        <option value="WINE > RED WINE">RED WINE</option>
                        <option value="WINE > WHITE WINE">WHITE WINE</option>
                        <option value="BEER">BEER</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="engraving" class="form-label">Engraving</label>
                      <select class="form-select" id="engraving">
                        <option value="">All</option>
                        <option value="YES">Yes</option>
                        <option value="NO">No</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="fulfillment" class="form-label">Fulfillment</label>
                      <select class="form-select" id="fulfillment" multiple>
                        <option value="shipping">Shipping</option>
                        <option value="onDemand">On Demand</option>
                      </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Search</button>
                  </form>
                </div>
                <div id="catalogResults"></div>
              </div>
            </div>
          </div>

          <!-- CART EXAMPLE -->
          <div class="tab-pane fade" id="cart" role="tabpanel" aria-labelledby="cart-tab">
            <div class="section-container">
              <h2 class="section-title">Cart</h2>
              <div class="cart-section">
                <div id="cartForm" class="cart-form mb-4">
                  <div class="mb-3">
                    <label for="cartIdGet" class="form-label">Cart ID</label>
                    <input type="text" class="form-control" id="cartIdGet">
                  </div>
                  <button type="button" class="btn btn-primary" id="getCart">Get Cart</button>
                  <span id="cartEventMessage"></span>
                </div>
                <div id="cartResults"></div>
                <div id="engravingModalContainer"></div>
                <hr>

                <div id="updateCartForm" class="cart-form mt-4">
                  <h5>Update Cart</h5>
                  <div class="mb-3">
                    <label for="cartIdUpdate" class="form-label">Cart ID</label>
                    <input type="text" class="form-control" id="cartIdUpdate">
                  </div>
                  <div class="mb-3">
                    <label for="partNumber" class="form-label">Part Number</label>
                    <input type="text" class="form-control" id="partNumber">
                  </div>
                  <div class="mb-3">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" class="form-control" id="quantity" min="1">
                  </div>
                  <div class="mb-3">
                    <label for="fulfillmentId" class="form-label">Fulfillment ID</label>
                    <input type="text" class="form-control" id="fulfillmentId">
                  </div>
                  <button type="button" class="btn btn-primary" id="updateCart">Update Cart</button>
                </div>
              </div>
            </div>
          </div>

          <!-- USER EXAMPLE -->
          <div class="tab-pane fade" id="user" role="tabpanel" aria-labelledby="user-tab">
            <div class="section-container">
              <h2 class="section-title">User Methods</h2>

              <div class="user-section">
                <h5>Create/Update User Session</h5>
                <form id="userSessionForm">
                  <div class="mb-3">
                    <label for="userEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="userEmail" required>
                  </div>
                  <div class="mb-3">
                    <label for="userFirstName" class="form-label">First Name</label>
                    <input type="text" class="form-control" id="userFirstName">
                  </div>
                  <button type="submit" class="btn btn-primary">Create/Update Session</button>
                </form>
                <div id="userSessionResult" class="session-result"></div>
              </div>
              <hr>

              <div class="user-section mt-4">
                <h5>Fetch User by ID (without creating session)</h5>
                <form id="fetchUserByIDForm">
                  <div class="mb-3">
                    <label for="userIDFetch" class="form-label">ID</label>
                    <input type="text" class="form-control" id="userIDFetch" required>
                  </div>
                  <button type="submit" class="btn btn-primary">Fetch User</button>
                </form>
                <div id="fetchUserByIDResult" class="mt-3 session-result"></div>
              </div>

              <div class="user-section mt-4">
                <h5>Purge User</h5>
                <form id="purgeUserForm">
                  <div class="mb-3">
                    <label for="purgeUserId" class="form-label">User ID or Email</label>
                    <input type="text" class="form-control" id="purgeUserId" required>
                  </div>
                  <button type="submit" class="btn btn-danger">Purge User</button>
                </form>
                <div id="purgeUserResult" class="mt-3"></div>
              </div>
              <hr>

              <div class="user-section mt-4">
                <h5>Update/Create Address</h>
                  <form id="updateAddressForm">
                    <div class="mb-3">
                      <label for="customerId" class="form-label">Customer ID</label>
                      <input type="text" class="form-control" id="customerId" required>
                    </div>
                    <div class="mb-3">
                      <label for="addressOne" class="form-label">Address Line 1</label>
                      <input type="text" class="form-control" id="addressOne" required>
                    </div>
                    <div class="mb-3">
                      <label for="addressCity" class="form-label">City</label>
                      <input type="text" class="form-control" id="addressCity" required>
                    </div>
                    <div class="mb-3">
                      <label for="addressState" class="form-label">State</label>
                      <input type="text" class="form-control" id="addressState" required>
                    </div>
                    <div class="mb-3">
                      <label for="isDefaultAddress" class="form-label">Set as Default?</label>
                      <input type="checkbox" id="isDefaultAddress">
                    </div>
                    <button type="submit" class="btn btn-primary">Update/Create Address</button>
                  </form>
                  <div id="updateAddressResult" class="mt-3"></div>
              </div>

              <hr>

              <div class="user-section mt-4">
                <h5>Update/Create Address (w/ Coordinates)</h>
                  <form id="updateAddressWithCoordsForm">
                    <div class="mb-3">
                      <label for="customerIdAddress" class="form-label">Customer ID</label>
                      <input type="text" class="form-control" id="customerIdAddress" required>
                    </div>
                    <div class="mb-3">
                      <label for="addressLat" class="form-label">Latitude</label>
                      <input type="text" class="form-control" id="addressLat" required>
                    </div>
                    <div class="mb-3">
                      <label for="addressLong" class="form-label">Longitude</label>
                      <input type="text" class="form-control" id="addressLong" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Update/Create Address</button>
                  </form>
                  <div id="updateAddressWithCoordsResult" class="mt-3"></div>
              </div>

              <hr>

              <div class="user-section mt-4">
                <h5>Update/Create Address (w/ Google PlacesId)</h>
                  <form id="updateAddressWithPlacesIdForm">
                    <div class="mb-3">
                      <label for="customerIdAddress" class="form-label">Customer ID</label>
                      <input type="text" class="form-control" id="customerIdAddressWithPlacesId" required>
                    </div>
                    <div class="mb-3">
                      <label for="addressLat" class="form-label">Places Id</label>
                      <input type="text" class="form-control" id="addressWithPlacesId" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Update/Create Address</button>
                  </form>
                  <div id="updateAddressWithPlacesIdResult" class="mt-3"></div>
              </div>

              <hr>

              <div class="user-section mt-4">
                <h5>Purge Address</h5>
                <form id="purgeAddressForm">
                  <div class="mb-3">
                    <label for="purgeAddressId" class="form-label">Address ID</label>
                    <input type="text" class="form-control" id="purgeAddressId" required>
                  </div>
                  <button type="submit" class="btn btn-danger">Purge Address</button>
                </form>
                <div id="purgeAddressResult" class="mt-3"></div>
              </div>
              <hr>

              <div class="user-section mt-4">
                <h5>Add Payment Method</h>
                  <form id="addPaymentMethodForm">
                    <div class="mb-3">
                      <label for="customerId" class="form-label">Customer ID</label>
                      <input type="text" class="form-control" id="addPaymentCustomerId" required>
                    </div>
                    <div class="mb-3">
                      <label for="paymentMethodId" class="form-label">Payment Method ID</label>
                      <input type="text" class="form-control" id="paymentMethodId" required>
                    </div>
                    <div class="mb-3">
                      <label for="isDefault" class="form-label">Set as Default?</label>
                      <input type="checkbox" id="isDefault">
                    </div>
                    <button type="submit" class="btn btn-primary">Add Payment Method</button>
                  </form>
                  <div id="addPaymentMethodResult" class="mt-3"></div>
              </div>
              <hr>

              <div class="user-section mt-4">
                <h5>Update Payment Method</h5>
                <form id="updatePaymentMethodForm">
                  <div class="mb-3">
                    <label for="updatePaymentCustomerId" class="form-label">Customer ID</label>
                    <input type="text" class="form-control" id="updatePaymentCustomerId" required>
                  </div>
                  <div class="mb-3">
                    <label for="updatePaymentMethodId" class="form-label">Payment Method ID</label>
                    <input type="text" class="form-control" id="updatePaymentMethodId" required>
                  </div>
                  <div class="mb-3">
                    <label for="updateIsDefault" class="form-label">Set as Default?</label>
                    <input type="checkbox" id="updateIsDefault">
                  </div>
                  <button type="submit" class="btn btn-primary">Update Payment Method</button>
                </form>
                <div id="updatePaymentMethodResult" class="mt-3"></div>
              </div>
              <hr>

              <div class="user-section mt-4">
                <h5>Purge Payment Method</h5>
                <form id="purgePaymentMethodForm">
                  <div class="mb-3">
                    <label for="purgeCustomerId" class="form-label">Customer ID</label>
                    <input type="text" class="form-control" id="purgeCustomerId" required>
                  </div>
                  <div class="mb-3">
                    <label for="purgePaymentId" class="form-label">Payment Method ID</label>
                    <input type="text" class="form-control" id="purgePaymentId" required>
                  </div>
                  <button type="submit" class="btn btn-danger">Purge Payment Method</button>
                </form>
                <div id="purgePaymentMethodResult" class="mt-3"></div>
              </div>
            </div>
          </div>

          <!-- PAYMENT SESSION EXAMPLE -->
          <div class="tab-pane fade" id="payment-session" role="tabpanel" aria-labelledby="payment-session-tab">
            <div class="section-container">
              <h2 class="section-title">Create Payment Session</h2>
              <form id="createPaymentSessionForm" class="payment-form">
                <div class="form-group">
                  <label for="paymentSessionCartId" class="form-label">Cart ID (Optional)</label>
                  <input type="text" id="paymentSessionCartId" class="form-input">
                </div>
                <div class="form-group">
                  <label for="paymentSessionCheckoutToken" class="form-label">Checkout Token (Optional)</label>
                  <input type="text" id="paymentSessionCheckoutToken" class="form-input">
                </div>
                <div class="form-group">
                  <label for="paymentSessionCustomerId" class="form-label">Customer ID (Optional)</label>
                  <input type="text" id="paymentSessionCustomerId" class="form-input">
                </div>
                <div class="form-group">
                  <label for="paymentSessionCustomerEmail" class="form-label">Customer Email (Optional)</label>
                  <input type="email" id="paymentSessionCustomerEmail" class="form-input">
                </div>
                <button type="submit" class="btn btn-primary mt-3">Create Payment Session</button>
              </form>
              <div id="paymentSessionResult" class="session-result mt-3"></div>
            </div>
          </div>

          <!-- PAYMENT EXAMPLE -->
          <div class="tab-pane fade" id="payment" role="tabpanel" aria-labelledby="payment-tab">
            <div class="section-container">
              <h2 class="section-title">Payment Method</h2>
              <form id="paymentForm" class="payment-form">
                <div class="form-group">
                  <label for="sessionKey" class="form-label">Session Key</label>
                  <input type="text" id="sessionKey" class="form-input" required>
                </div>
                <div class="form-group">
                  <label for="sessionSecret" class="form-label">Session Secret</label>
                  <input type="text" id="sessionSecret" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary">Mount Payment Element</button>
              </form>
              <div id="payment-element-container" class="payment-element-container"></div>
              <div id="paymentTokenResult" class="payment-token-result"></div>
              <div class="button-group">
                <button id="generateTokenButton" class="btn btn-secondary">Generate Payment Token</button>
                <button id="collapsePaymentButton" class="btn btn-secondary">Collapse Payment Element</button>
                <button id="unmountPaymentButton" class="btn btn-warning">Unmount Payment Element</button>
                <button id="destroyPaymentButton" class="btn btn-danger">Destroy Payment Element</button>
              </div>
            </div>
          </div>

          <!-- CHECKOUT EXAMPLE -->
          <div class="tab-pane fade" id="checkout" role="tabpanel" aria-labelledby="checkout-tab">
            <div class="section-container">
              <h2 class="section-title">Checkout</h2>
              <form id="checkoutForm">
                <div class="mb-3">
                  <label for="checkoutCartId" class="form-label">Checkout Cart ID</label>
                  <input type="text" class="form-control" id="checkoutCartId" required>
                </div>
                <button type="submit" class="btn btn-primary">Prepare Checkout</button>
              </form>

              <div id="checkoutResults" class="mt-3"></div>

              <hr>

              <!-- Complete Checkout Form -->
              <h2 class="section-title">Complete Checkout</h2>
              <form id="completeCheckoutForm">
                <div class="mb-3">
                  <label for="checkoutToken" class="form-label">Checkout Token</label>
                  <input type="text" class="form-control" id="checkoutToken" required>
                </div>
                <div class="mb-3">
                  <label for="paymentId" class="form-label">Payment ID</label>
                  <input type="text" class="form-control" id="paymentId" required>
                </div>
                <button type="submit" class="btn btn-success">Complete Checkout</button>
              </form>

              <div id="completeCheckoutResults" class="mt-3"></div>
            </div>
          </div>

          <!-- ORDER EXAMPLE -->
          <div class="tab-pane fade" id="order" role="tabpanel" aria-labelledby="order-tab">
            <div class="section-container">
              <h2 class="section-title">Order Details</h2>
              <div class="order-section">
                <div id="orderForm" class="order-form mb-4">
                  <div class="mb-3">
                    <label for="orderId" class="form-label">Order ID or Number</label>
                    <input type="text" class="form-control" id="orderId" placeholder="Enter order ID or number (e.g. 187231231)">
                  </div>
                  <button type="button" class="btn btn-primary" id="getOrder">Fetch Order</button>
                </div>
                <div id="orderResults"></div>
              </div>
            </div>
          </div>

          <!-- Webhook Tab Content -->
          <div class="tab-pane fade" id="webhook" role="tabpanel" aria-labelledby="webhook-tab">
            <div class="section-container">
              <h2 class="section-title">Webhook Test</h2>
              <div class="row justify-content-center mt-4">
                <div class="col-md-8 text-center">
                  <p>Send a test webhook event to verify your webhook configuration.</p>

                  <div class="mb-4">
                    <div class="form-group">
                      <label for="webhookEndpoint" class="form-label text-start d-block mb-2">Custom Endpoint (Optional)</label>
                      <input type="text" id="webhookEndpoint" class="form-control" placeholder="https://your-webhook-endpoint.com/webhook">
                      <small class="form-text text-muted text-start d-block mt-2">
                        If left empty, the system will use the default webhook endpoint configured in your account settings.
                      </small>
                    </div>
                  </div>

                  <button type="button" class="btn btn-primary" id="testWebhookButton">Trigger Test Event</button>
                  <div id="webhookTestResult" class="mt-3"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- AUTH EXAMPLE -->
          <div class="tab-pane fade" id="auth" role="tabpanel" aria-labelledby="auth-tab">
            <div class="section-container">
              <h2 class="section-title">Authentication Details</h2>
                <button type="button" class="btn btn-primary" id="getAuthDetails">Get Auth Details</button>
              <div id="authResult" class="session-result mt-3"></div>
            </div>
          </div>

          <!-- PAYMENT ELEMENT V2 EXAMPLE -->
          <div class="tab-pane fade" id="payment-element-v2" role="tabpanel" aria-labelledby="payment-element-v2-tab">
            <div class="section-container">
              <h2 class="section-title">Payment Element V2</h2>

              <!-- Step 1: Create Payment Session -->
              <div class="mb-4 p-3 border rounded shadow-sm">
                <h5>Step 1: Create Payment Session</h5>
                <form id="peV2CreatePaymentSessionForm" class="payment-form">
                  <div class="form-group">
                    <label for="peV2PaymentSessionCartId" class="form-label">Cart ID (Optional)</label>
                    <input type="text" id="peV2PaymentSessionCartId" class="form-input">
                  </div>
                  <div class="form-group">
                    <label for="peV2PaymentSessionCheckoutToken" class="form-label">Checkout Token (Optional)</label>
                    <input type="text" id="peV2PaymentSessionCheckoutToken" class="form-input">
                  </div>
                  <div class="form-group">
                    <label for="peV2PaymentSessionCustomerId" class="form-label">Customer ID (Optional)</label>
                    <input type="text" id="peV2PaymentSessionCustomerId" class="form-input">
                  </div>
                  <div class="form-group">
                    <label for="peV2PaymentSessionCustomerEmail" class="form-label">Customer Email (Optional)</label>
                    <input type="email" id="peV2PaymentSessionCustomerEmail" class="form-input">
                  </div>
                  <button type="submit" class="btn btn-primary mt-3">Create Session for Element</button>
                </form>
                <div id="peV2PaymentSessionResult" class="session-result mt-3" style="display:none;">
                  <h6>Payment Session Created:</h6>
                  <div class="session-detail"><strong>Key:</strong> <span id="peV2SessionKey"></span></div>
                  <div class="session-detail"><strong>Secret:</strong> <span id="peV2SessionSecret"></span></div>
                  <p><strong>Created At:</strong> <span id="peV2SessionCreatedAt"></span></p>
                </div>
              </div>

              <!-- Step 2: Configure and Mount Payment Element -->
              <div class="mb-4 p-3 border rounded shadow-sm">
                <h5>Step 2: Mount Payment Element</h5>
                <div class="form-group">
                  <label for="peV2ElementId" class="form-label">Target Element ID for Mounting</label>
                  <input type="text" id="peV2ElementId" class="form-input" value="liquid-payment-element-v2-container">
                </div>
                <div id="liquid-payment-element-v2-container" class="payment-element-container my-3">
                  <!-- Payment Element will be mounted here -->
                </div>
                 <div class="form-group">
                    <label for="peV2AppearanceTheme" class="form-label">Appearance Theme (Optional)</label>
                    <select id="peV2AppearanceTheme" class="form-select">
                        <option value="default" selected>Default</option>
                        <option value="night">Night</option>
                        <option value="flat">Flat</option>
                    </select>
                </div>
                <div class="form-group mt-2">
                    <label for="peV2Layout" class="form-label">Layout (Optional)</label>
                    <select id="peV2Layout" class="form-select">
                        <option value="tabs" selected>Tabs</option>
                        <option value="accordion">Accordion</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <button type="button" class="btn btn-success mt-3" id="mountPeV2Button" disabled>Mount Element</button>
              </div>

              <!-- Step 3: Interact with Payment Element -->
              <div class="mb-4 p-3 border rounded shadow-sm">
                <h5>Step 3: Interact with Element</h5>
                <div class="button-group my-3">
                  <button type="button" class="btn btn-primary" id="createPeV2ConfirmationTokenButton" disabled>Create Confirmation Token</button>
                  <button type="button" class="btn btn-info" id="collapsePeV2Button" disabled>Collapse Element</button>
                </div>
                <div class="button-group my-1">
                  <button type="button" class="btn btn-warning" id="unmountPeV2Button" disabled>Unmount Element</button>
                  <button type="button" class="btn btn-danger" id="destroyPeV2Button" disabled>Destroy Element</button>
                </div>
                <div id="peV2InteractionResult" class="session-result mt-3"></div>
              </div>

              <!-- Step 4: Event Subscription -->
              <div class="p-3 border rounded shadow-sm">
                <h5>Step 4: Event Handling</h5>
                <div class="form-check form-switch my-2">
                  <input class="form-check-input" type="checkbox" role="switch" id="subscribeToPeV2ReadyEvent">
                  <label class="form-check-label" for="subscribeToPeV2ReadyEvent">Subscribe to 'ready'</label>
                </div>
                <div class="form-check form-switch my-2">
                  <input class="form-check-input" type="checkbox" role="switch" id="subscribeToPeV2ChangeEvent">
                  <label class="form-check-label" for="subscribeToPeV2ChangeEvent">Subscribe to 'change'</label>
                </div>
                <div class="form-check form-switch my-2">
                  <input class="form-check-input" type="checkbox" role="switch" id="subscribeToPeV2FocusEvent">
                  <label class="form-check-label" for="subscribeToPeV2FocusEvent">Subscribe to 'focus'</label>
                </div>
                 <div class="form-check form-switch my-2">
                  <input class="form-check-input" type="checkbox" role="switch" id="subscribeToPeV2BlurEvent">
                  <label class="form-check-label" for="subscribeToPeV2BlurEvent">Subscribe to 'blur'</label>
                </div>
                <div class="form-check form-switch my-2">
                  <input class="form-check-input" type="checkbox" role="switch" id="subscribeToPeV2LoadErrorEvent">
                  <label class="form-check-label" for="subscribeToPeV2LoadErrorEvent">Subscribe to 'loaderror'</label>
                </div>
                 <div class="form-check form-switch my-2">
                  <input class="form-check-input" type="checkbox" role="switch" id="subscribeToPeV2LoaderStartEvent">
                  <label class="form-check-label" for="subscribeToPeV2LoaderStartEvent">Subscribe to 'loaderstart'</label>
                </div>
                <div id="peV2EventLog" class="mt-3 p-2" style="max-height: 200px; overflow-y: auto; background-color: #e9ecef; border-radius: 4px;">
                  <small><em>Event logs will appear here...</em></small>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</main>

<footer class="footer-top">
  <div class="container">
    <div class="footer-content">
      <div class="footer-logo">
        <img src="https://assets.liquidcommerce.co/development/cloud-sdk-logo.svg" style="max-width: 250px;" alt="Logo">
      </div>
      <div>
        <small>Â© Liquid Commerce Technologies</small>
      </div>
    </div>
  </div>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
<!--<script src="https://assets.liquidcommerce.co/sdk/cloud/stage/liquidcommerce-cloud-sdk.min.js"></script>-->
 <script src="../umd/liquidcommerce-cloud-sdk.min.js"></script>
<script>
  /**
   * Liquid Commerce SDK Integration Script
   *
   * This script demonstrates the integration of the Liquid Commerce SDK
   * for various e-commerce functionalities including address search,
   * catalog search, cart management, user session handling, payment processing,
   * and checkout flow.
   */

  // API Keys and Constants
  const API_KEY = 'e71df2ac1edf89c83095dcfd100115aa6a1ad1efd922e4e70e919a12';
  const ORDER_API_USER = 'YOUR_ORDER_API_USER';
  const ORDER_API_PASSWORD = 'YOUR_ORDER_API_PASSWORD';
  const GOOGLE_PLACES_API_KEY = 'AIzaSyD_LT-4RhPTrURUZjrrDtB3zIor0WFO6hE';
  const NEW_YORK_ADDRESS = {
    one: '100 madison ave',
    two: 'apt 1707',
    city: 'New york',
    state: 'NY',
    zip: '10016',
  };

  let client;

  let orderClient;
  let paymentElementV2; // Variable to hold the Payment Element V2 instance
  let peV2SessionData = null; // To store session key and secret

  /**
   * Debounce function to limit the rate at which a function can fire.
   * @param {Function} func - The function to debounce
   * @param {number} wait - The number of milliseconds to delay
   * @returns {Function} A debounced version of the passed function
   */
  function debounce( func, wait ) {
    let timeout;
    return function executedFunction( ...args ) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  /**
   * Initialize the Liquid Commerce SDK
   * @returns {Promise<Object>} The initialized SDK client
   */
  async function initSDK() {
    try {
      return await window.LiquidCommerce(API_KEY, {
        googlePlacesApiKey: GOOGLE_PLACES_API_KEY,
        env: 'loc',
      });
    } catch (error) {
      console.error('Failed to initialize SDK:', error);
      document.getElementById('results').innerHTML = `<p>Error initializing SDK: ${error.message}</p>`;
    }
  }

  /**
   * Initialize the Liquid Commerce SDK
   * @returns {Promise<Object>} The initialized SDK order client
   */
  async function initOrderSDK() {
    try {
      return await window.LiquidCommerceOrders({
        userID: ORDER_API_USER,
        password: ORDER_API_PASSWORD,
        env: 'loc',
      });
    } catch (error) {
      console.error('Failed to initialize order SDK:', error);
      document.getElementById('results').innerHTML += `<p>Error initializing order SDK: ${error.message}</p>`;
    }
  }

  /**
   * Search for an address using the SDK's autocomplete feature
   */
  async function searchAddress() {
    const addressInput = document.getElementById('addressInput');
    const autocompleteResults = document.getElementById('autocompleteResults');

    if (!client) {
      autocompleteResults.innerHTML = '<li>SDK not initialized. Please try again.</li>';
      return;
    }

    const input = addressInput.value.trim();

    if (input.length < 3) {
      autocompleteResults.innerHTML = '';
      return;
    }

    try {
      const results = await client.address.autocomplete({ input });
      autocompleteResults.innerHTML = results.data.map(result =>
        `<li data-id="${result.id}">${result.description}</li>`,
      ).join('');
    } catch (error) {
      autocompleteResults.innerHTML = `<li>Error: ${error.message}</li>`;
    }
  }

  /**
   * Get details for a selected address
   * @param {string} id - The ID of the selected address
   */
  async function getDetails( id ) {
    const resultsDiv = document.getElementById('results');

    if (!client) {
      resultsDiv.innerHTML = '<p>SDK not initialized. Please try again.</p>';
      return;
    }

    try {
      const detailsResult = await client.address.details({ id });
      let html = '<h2>Address Details:</h2>';
      html += `<p>Formatted Address: ${detailsResult.data.formattedAddress}</p>`;
      html += `<p>Latitude: ${detailsResult.data.coords.lat}</p>`;
      html += `<p>Longitude: ${detailsResult.data.coords.long}</p>`;
      resultsDiv.innerHTML = html;
    } catch (error) {
      resultsDiv.innerHTML = `<p>Error: ${error.message}</p>`;
    }
  }

  /**
   * Search the catalog based on user input
   * @param {Event} event - The form submission event
   */
  async function searchCatalog(event) {
    event.preventDefault();
    const searchQuery = document.getElementById('searchQuery').value;
    const category = document.getElementById('category').value;
    const engraving = document.getElementById('engraving').value;
    const fulfillmentSelect = document.getElementById('fulfillment');
    const fulfillment = Array.from(fulfillmentSelect.selectedOptions).map(option => option.value);
    const catalogResults = document.getElementById('catalogResults');

    if (!client) {
      catalogResults.innerHTML = '<p>SDK not initialized. Please try again.</p>';
      return;
    }

    try {
      const filters = [];

      if (category) {
        filters.push({
          key: "categories",
          values: [category]
        });
      }

      console.log("engraving: ", engraving)
      if (engraving) {
        filters.push({
          key: "engraving",
          values: engraving
        });
      }

      if (fulfillment.length > 0) {
        filters.push({
          key: "fulfillment",
          values: fulfillment
        });
      }

      const response = await client.catalog.search({
        search: searchQuery,
        loc: {
          address: NEW_YORK_ADDRESS,
        },
        filters: filters,
        isLegacy: true,
        isLean: false,
      });
      displayCatalogResults(response);
    } catch (error) {
      console.error('Error searching catalog:', error);
      catalogResults.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  }

  /**
   * Display catalog search results
   * @param {Object} response - The catalog search response
   */
  function displayCatalogResults( response ) {
    const catalogResults = document.getElementById('catalogResults');
    let html = '<h3 class="mb-4">Catalog Search Results:</h3>';

    if (response.products && response.products.length > 0) {
      html += '<div class="col row-cols-1 row-cols-md-2">';
      response.products.forEach(product => {
        html += `
      <div class="col w-100 mb-3">
        <div class="card">
         <div class="row p-2" style="align-items: center">
          <div class="w-50">
            <img src="${product.images[0] || 'https://via.placeholder.com/300x200?text=No+Image'}" class="card-img-top" alt="${product.name}">
          </div>
          <div class="w-50">
            <h5 class="card-title">${product.name}</h5>
            <p class="card-text">Brand: ${product.brand}</p>
            <p class="card-text">Category: ${product.category}</p>
          </div>
         </div>
          <div class="card-body">
            <h6>Available Sizes:</h6>
            <div class="d-flex flex-wrap gap-2 p-2 w-100">
              ${product.sizes.map(size => {
          const availableVariants = size.variants.filter(variant => variant.stock > 0);
          const lowestPrice = availableVariants.length > 0
            ? Math.min(...availableVariants.map(variant => variant.price))
            : null;
          const formattedPrice = lowestPrice !== null
            ? `$${(lowestPrice / 100).toFixed(2)}`
            : 'Not available';
          return `
            <div class="flex-grow-1 flex-shrink-0 flex-basis-0 min-width-0 p-3 border rounded shadow-sm" style="min-width: 200px;">
         <h5 class="mb-2"><strong>${size.size}</strong></h5>
               <p class="mb-1">UPC: ${size.upc}</p>
               <p class="mb-1">Lowest Price: <span class="text-primary">${formattedPrice}</span></p>
               <p class="mb-0">Available Variants: <span class="badge bg-secondary">${availableVariants.length}</span></p>
            </div>
                `;
        }).join('')}
            </div>
          </div>
        </div>
      </div>
    `;
      });
      html += '</div>';
    } else {
      html += '<p>No products found for the given search criteria.</p>';
    }

    // Display navigation and filter information
    if (response.navigation) {
      if (response.navigation.totalCount) {
        html += `<p class="mt-3">Total results: ${response.navigation.totalCount}</p>`;
      }

      if (response.navigation.filters && response.navigation.filters.length > 0) {
        html += '<h3 class="mt-4 mb-3">Available Filters:</h3>';
        html += '<ul class="list-group">';
        response.navigation.filters.forEach(filter => {
          html += `
          <li class="list-group-item">
            <strong>${filter.bucket}:</strong>
            ${filter.values.map(value => `${value.value} (${value.count})`).join(', ')}
          </li>
        `;
        });
        html += '</ul>';
      }
    }

    catalogResults.innerHTML = html;

    // Display metadata
    if (response.metadata) {
      const metadataHtml = `
      <div class="mt-4">
        <h4>Response Metadata:</h4>
        <p>Request ID: ${response.metadata.requestId}</p>
        <p>Timestamp: ${new Date(response.metadata.timestamp).toLocaleString()}</p>
        <p>Path: ${response.metadata.path}</p>
      </div>
    `;
      catalogResults.innerHTML += metadataHtml;
    }
  }

  /**
   * Check availability of products
   * @param {Event} event - The form submission event
   */
  async function checkAvailability( event ) {
    event.preventDefault();
    const upcs = document.getElementById('upcs').value.split(',').map(upc => upc.trim());
    const zipCode = document.getElementById('zipCode').value;
    const availabilityResults = document.getElementById('availabilityResults');

    if (!client) {
      availabilityResults.innerHTML = '<p>SDK not initialized. Please try again.</p>';
      return;
    }

    try {
      const response = await client.catalog.availability({
        upcs: upcs,
        loc: {
          address: NEW_YORK_ADDRESS,
        },
        isLegacy: true,
        isLean: false,
      });
      displayAvailabilityResults(response);
    } catch (error) {
      console.error('Error checking availability:', error);
      availabilityResults.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  }

  /**
   * Display availability results
   * @param {Object} response - The availability check response
   */
  function displayAvailabilityResults( response ) {
    const availabilityResults = document.getElementById('availabilityResults');
    let html = '<h4>Availability Results:</h4>';

    if (response.products && response.products.length > 0) {
      html += '<ul class="list-group">';
      response.products.forEach(product => {
        const availability = product.sizes[0].variants[0].stock > 0 ? 'In Stock' : 'Out of Stock';
        html += `
        <li class="list-group-item">
          <div class="availability-product">
            <img src="${product.images[0] || 'https://via.placeholder.com/300x200?text=No+Image'}" class="availability-product-image" alt="${product.name}">
            <div>
              <h5><b>${product.name}</b></h5>
              <p>UPC: ${product.sizes[0].upc}</p>
              <p>Size: ${product.sizes[0].size}</p>
              <p>Availability: ${availability}</p>
              <p>Price: $${product.sizes[0].variants[0].price.toFixed(2)}</p>
            </div>
          </div>
        </li>
      `;
      });
      html += '</ul>';
    } else {
      html += '<p>No products found.</p>';
    }

    availabilityResults.innerHTML = html;
  }

  // Event Listeners and Initialization

  document.addEventListener('DOMContentLoaded', async () => {
    client = await initSDK();
    // orderClient = await initOrderSDK();

    const addressInput = document.getElementById('addressInput');
    const autocompleteResults = document.getElementById('autocompleteResults');
    const availabilityForm = document.getElementById('availabilityForm');
    const searchForm = document.getElementById('searchForm');

    const debouncedSearchAddress = debounce(searchAddress, 300);
    addressInput.addEventListener('input', debouncedSearchAddress);

    autocompleteResults.addEventListener('click', ( event ) => {
      if (event.target.tagName === 'LI') {
        const id = event.target.getAttribute('data-id');
        addressInput.value = event.target.textContent;
        autocompleteResults.innerHTML = '';
        getDetails(id);
      }
    });

    availabilityForm.addEventListener('submit', checkAvailability);
    searchForm.addEventListener('submit', searchCatalog);
  });

  // Cart Management

  document.getElementById('getCart').addEventListener('click', async () => {
    const cartId = document.getElementById('cartIdGet').value;
    try {
      const cartResponse = await client.cart.get(cartId);
      displayCartResults(cartResponse);
    } catch (error) {
      console.error('Error getting cart:', error);
      alert('Failed to get cart. Please try again.');
    }
  });

  /**
   * Display cart results
   * @param {Object} cartResponse - The cart response object
   */
  function displayCartResults( cartResponse ) {
    const cartResults = document.getElementById('cartResults');
    const cartEventMessage = document.getElementById('cartEventMessage');
    cartResults.innerHTML = '';

    if (cartResponse && cartResponse.cart && cartResponse.cart.id) {
      const cart = cartResponse.cart;
      const cartSummary = document.createElement('div');
      const cartEvent = document.createElement('div');

      cartSummary.innerHTML = `
    <h4>Cart Summary</h4>
    <p>Cart ID: ${cart.id}</p>
    <p>Total Items: ${cart.quantity}</p>
    <p>Subtotal: $${(cart.subtotal / 100).toFixed(2)}</p>
    <p>Total: $${(cart.total / 100).toFixed(2)}</p>
    <p>Platform Fee: $${(cart.platformFee / 100).toFixed(2)}</p>
    <p>Shipping Fee: $${(cart.shippingFee / 100).toFixed(2)}</p>
  `;

      if (cart.events && cart.events.length > 0) {
        cartEvent.innerHTML = `
     <p><b>Message</b>: ${cart.events[0].message}</p>
     `;
        cartResults.appendChild(cartEvent);
      }
      cartResults.appendChild(cartSummary);

      function findFulfillmentOfRetailer( cart, itemRetailerId, itemFulfillmentId ) {
        const itemWithRetailer = cart.items.find(( item ) => item.retailerId === itemRetailerId);
        if (!itemWithRetailer) {
          return null;
        }
        const retailer = cart.retailers.find(( retailer ) => retailer.id === itemRetailerId);
        return retailer.fulfillments.find(( fulfillment ) => fulfillment.id === itemFulfillmentId);
      }


      if (cart.items && cart.items.length > 0) {
        const itemsList = document.createElement('ul');
        itemsList.className = 'list-group mt-3';

        cart.items.forEach(( item, index ) => {
          const retailer = cart.retailers.find(( r ) => r.id === item.retailerId);
          const retailerFulfillment = findFulfillmentOfRetailer(cart, item.retailerId, item.fulfillmentId);

          const listItem = document.createElement('li');
          listItem.className = 'list-group-item';

          const itemName = document.createElement('strong');
          itemName.textContent = item.name;
          listItem.appendChild(itemName);
          listItem.appendChild(document.createElement('br'));

          const itemDetails = [
            { label: 'Part Number', value: item.partNumber },
            { label: 'Quantity', value: `<b>${item.quantity}</b>` },
            { label: 'Size', value: item.size },
            { label: 'Unit Price', value: `$${(item.unitPrice / 100).toFixed(2)}` },
            { label: 'Total', value: `<b>$${((item.quantity * item.unitPrice) / 100).toFixed(2)}</b>` },
            { label: 'Retailer Name', value: `<b>${retailer.name}</b>` },
            { label: 'Retailer Shipping Fee', value: `$${(retailer.shippingFee / 100).toFixed(2)}` },
            { label: 'Fulfillment ID', value: item.fulfillmentId },
          ];

          itemDetails.forEach(( detail ) => {
            const span = document.createElement('span');
            span.innerHTML = `${detail.label}: ${detail.value}`;
            listItem.appendChild(span);
            listItem.appendChild(document.createElement('br'));
          });

          if (retailerFulfillment.canEngrave === true) {
            const engravingLines = item.attributes?.engraving?.lines || [];

            if (engravingLines.length === 0) {
              const engravingText = document.createTextNode('This item is engravable. Add custom engraving by clicking the button. ');
              listItem.appendChild(engravingText);
              const engravingButton = document.createElement('button');
              engravingButton.type = 'button';
              engravingButton.className = 'btn btn-primary p-1 w-auto';
              engravingButton.textContent = 'Add Engraving';
              engravingButton.onclick = function() {
                openEngravingModal(item, cart);
              };
              listItem.appendChild(engravingButton);
            } else {
              const engravingInfo = document.createTextNode(`This item has been engraved. Current Engraving: ${engravingLines.join(', ')}.  `);
              listItem.appendChild(engravingInfo);

              const editEngravingButton = document.createElement('button');
              editEngravingButton.type = 'button';
              editEngravingButton.className = 'btn btn-primary p-1 w-auto';
              editEngravingButton.textContent = 'Edit Engraving';
              editEngravingButton.onclick = function() {
                openEngravingModal(item, cart);
              };
              listItem.appendChild(editEngravingButton);
            }
          } else {
            const notEngravableText = document.createTextNode('This item is not engravable.');
            listItem.appendChild(notEngravableText);
          }

          itemsList.appendChild(listItem);
        });

        cartResults.appendChild(itemsList);
      }
    } else {
      cartResults.textContent = 'No cart data available.';
    }
  }

  function openEngravingModal( item, cart ) {
    const modalContainer = document.createElement('div');
    modalContainer.className = 'modal';
    modalContainer.id = 'engravingModal';
    modalContainer.tabIndex = '-1';
    modalContainer.setAttribute('role', 'dialog');

    const modalDialog = document.createElement('div');
    modalDialog.className = 'modal-dialog';
    modalDialog.setAttribute('role', 'document');

    const modalContent = document.createElement('div');
    modalContent.className = 'modal-content';

    const modalHeader = document.createElement('div');
    modalHeader.className = 'modal-header';

    const modalTitle = document.createElement('h5');
    modalTitle.className = 'modal-title';
    modalTitle.textContent = 'Add Engraving';

    const closeButton = document.createElement('button');
    closeButton.type = 'button';
    closeButton.className = 'btn btn-secondary w-auto';
    closeButton.setAttribute('data-dismiss', 'modal');
    closeButton.setAttribute('aria-label', 'Close');
    closeButton.onclick = closeModal;

    const closeSpan = document.createElement('span');
    closeSpan.setAttribute('aria-hidden', 'true');
    closeSpan.innerHTML = '&times;';

    closeButton.appendChild(closeSpan);
    modalHeader.appendChild(modalTitle);
    modalHeader.appendChild(closeButton);

    const modalBody = document.createElement('div');
    modalBody.className = 'modal-body';

    const existingLines = item.attributes?.engraving?.lines || ['', ''];
    const maxCharsPerLine = item.attributes?.engraving?.maxCharsPerLine;
    const noOfLines = item.attributes?.engraving?.maxLines || 2;

    for (let i = 0; i < noOfLines; i++) {
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control mb-2 rounded-none border-x-0 border-t-0 border-b-foreground-medium font-sourceSans3 text-[12px] focus-visible:border-b-foreground-medium focus-visible:ring-0 focus-visible:ring-transparent focus-visible:ring-offset-0';
      input.id = `engravingLine${i + 1}`;
      input.placeholder = `Line ${i + 1}`;
      input.value = existingLines[i] || '';
      input.maxLength = maxCharsPerLine;
      modalBody.appendChild(input);
    }

    const modalFooter = document.createElement('div');
    modalFooter.className = 'modal-footer';

    const closeModalButton = document.createElement('button');
    closeModalButton.type = 'button';
    closeModalButton.className = 'btn btn-secondary w-auto';
    closeModalButton.textContent = 'Close';
    closeModalButton.onclick = closeModal;

    const saveButton = document.createElement('button');
    saveButton.type = 'button';
    saveButton.className = 'btn btn-primary w-auto';
    saveButton.textContent = 'Save Engraving';
    saveButton.onclick = function() {
      saveEngraving(item, cart);
    };

    modalFooter.appendChild(closeModalButton);
    modalFooter.appendChild(saveButton);

    modalContent.appendChild(modalHeader);
    modalContent.appendChild(modalBody);
    modalContent.appendChild(modalFooter);

    modalDialog.appendChild(modalContent);
    modalContainer.appendChild(modalDialog);

    const engravingModalContainer = document.getElementById('engravingModalContainer');
    engravingModalContainer.innerHTML = '';
    engravingModalContainer.appendChild(modalContainer);

    modalContainer.style.display = 'block';
    modalContainer.classList.add('show');
  }

  function closeModal() {
    const modal = document.getElementById('engravingModal');
    if (modal) {
      modal.style.display = 'none';
      modal.classList.remove('show');
      const engravingModalContainer = document.getElementById('engravingModalContainer');
      engravingModalContainer.innerHTML = '';
    }
  }

  async function saveEngraving( item, cart ) {
    const engravingLines = Array.from({ length: item.attributes?.engraving?.maxLines || 2 }, ( _, i ) =>
      document.getElementById(`engravingLine${i + 1}`).value,
    );

    const cartId = cart.id;
    const partNumber = item.partNumber;
    const address = cart.loc.address;

    try {
      const itemIndex = cart.items.findIndex(( cartItem ) => cartItem.partNumber === partNumber);

      if (itemIndex === -1) {
        throw new Error('Item not found in cart');
      }

      const updatedItems = cart.items.map(( cartItem, index ) => {
        if (index === itemIndex) {
          return {
            ...cartItem,
            engravingLines: engravingLines.filter(Boolean),
          };
        }
        return cartItem;
      });

      const updateParams = {
        id: cartId,
        items: updatedItems,
        loc: {
          address: address,
        },
      };

      const updatedCartResponse = await client.cart.update(updateParams);

      displayCartResults(updatedCartResponse);
      closeModal();
    } catch (error) {
      console.error('Error updating engraving:', error);
      alert('Failed to update engraving. Please try again.');
    }
  }


  document.getElementById('updateCart').addEventListener('click', async () => {
    const cartId = document.getElementById('cartIdUpdate').value;
    const partNumber = document.getElementById('partNumber').value;
    const quantity = parseInt(document.getElementById('quantity').value, 10);
    const fulfillmentId = document.getElementById('fulfillmentId').value;

    try {
      const updateParams = {
        id: cartId,
        items: [{
          partNumber,
          quantity,
          fulfillmentId,
        }],
        loc: {
          address: NEW_YORK_ADDRESS,
        },
      };
      console.log('updateParams:', updateParams);

      const updatedCartResponse = await client.cart.update(updateParams);

      console.log('updatedCartResponse:', updatedCartResponse);
      displayCartResults(updatedCartResponse);
    } catch (error) {
      console.error('Error updating cart:', error);
      alert('Failed to update cart. Please try again.');
    }
  });


  // User Session Management
  document.getElementById('userSessionForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const email = document.getElementById('userEmail').value;
    const firstName = document.getElementById('userFirstName').value;
    const userSessionResult = document.getElementById('userSessionResult');

    try {
      const sessionResponse = await client.user.session({ email, firstName });
      displayUserSession(sessionResponse);
    } catch (error) {
      console.error('Failed to create/update session:', error);
      userSessionResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  function displayUserSession( sessionResponse ) {
    const { data, metadata, message, statusCode } = sessionResponse;
    const userSessionResult = document.getElementById('userSessionResult');
    const formattedCreatedAt = new Date(data.createdAt).toLocaleString();
    const formattedUpdatedAt = new Date(data.updatedAt).toLocaleString();

    let addressesHtml = data.addresses.length === 0 ? `
        <p>
            There are no saved addresses for this user.
        </p>
    ` : data.addresses.map(address => `
        <p>
            <strong>Address:</strong> ${address.one}, ${address.city}, ${address.state}, ${address.zip}, ${address.country}
            <br><strong>Type:</strong> ${address.type}, <strong>Default:</strong> ${address.isDefault ? 'Yes' : 'No'}
        </p>
    `).join('');

    let paymentsHtml = data.savedPayments.length === 0 ? `
        <p>
            There are no saved payments for this user.
        </p>
    ` : data.savedPayments.map(payment => `
        <li>
            <strong>Type:</strong> ${payment.type}, <strong>Default:</strong> ${payment.isDefault ? 'Yes' : 'No'}
            <br>Card: ${payment.card.brand} ending in ${payment.card.last4}, Expires ${payment.card.expMonth}/${payment.card.expYear}
        </li>
    `).join('');

    let html = `
        <h4>User Session Details</h4>
        <p><strong>Status:</strong> ${statusCode} - ${message}</p>
        <p><strong>ID:</strong> ${data.id || 'N/A'}</p>
        <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
        <p><strong>First Name:</strong> ${data.firstName || 'N/A'}</p>
        <p><strong>Last Name:</strong> ${data.lastName || 'N/A'}</p>
        <p><strong>Phone:</strong> ${data.phone || 'N/A'}</p>
        <p><strong>Profile Image:</strong> ${data.profileImage ? `<img src="${data.profileImage}" alt="Profile Image" style="width:100px;">` : 'N/A'}</p>
        <p><strong>Created At:</strong> ${formattedCreatedAt}</p>
        <p><strong>Updated At:</strong> ${formattedUpdatedAt}</p>
        <h5>Addresses:</h5>
        ${addressesHtml}
        <h5>Saved Payments:</h5>
        <ul>${paymentsHtml}</ul>
        <h5>Session Key Details:</h5>
        <div class="session-detail">
            <strong>Session Key:</strong> ${data.session.key}
        </div>
        <div class="session-detail">
            <strong>Session Secret:</strong> ${data.session.secret}
        </div>
    `;

    userSessionResult.innerHTML = html;
  }

  /**
   * Handle user fetch request
   */
  document.getElementById('fetchUserByIDForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    const id = document.getElementById('userIDFetch').value;
    const fetchUserByIDResult = document.getElementById('fetchUserByIDResult');

    console.log("id: ", id)

    try {
      const userFetchedByID = await client.user.fetch(id);
      const { data, metadata, message, statusCode } = userFetchedByID;

      const formattedCreatedAt = new Date(data.createdAt).toLocaleString();
      const formattedUpdatedAt = new Date(data.updatedAt).toLocaleString();

      let addressesHtml = data.addresses.length === 0 ? `
        <p>
            There are no saved addresses for this user.
        </p>
    ` : data.addresses.map(address => `
        <p>
            <strong>Address:</strong> ${address.one}, ${address.city}, ${address.state}, ${address.zip}, ${address.country}
            <br><strong>Type:</strong> ${address.type}, <strong>Default:</strong> ${address.isDefault ? 'Yes' : 'No'}
        </p>
    `).join('');

      let paymentsHtml = data.savedPayments.length === 0 ? `
        <p>
            There are no saved payments for this user.
        </p>
    ` : data.savedPayments.map(payment => `
        <li>
            <strong>Type:</strong> ${payment.type}, <strong>Default:</strong> ${payment.isDefault ? 'Yes' : 'No'}
            <br>Card: ${payment.card.brand} ending in ${payment.card.last4}, Expires ${payment.card.expMonth}/${payment.card.expYear}
        </li>
    `).join('');

      let html = `
        <h4>User Fetch Details</h4>
        <p><strong>Status:</strong> ${statusCode} - ${message}</p>
        <p><strong>ID:</strong> ${data.id || 'N/A'}</p>
        <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
        <p><strong>First Name:</strong> ${data.firstName || 'N/A'}</p>
        <p><strong>Last Name:</strong> ${data.lastName || 'N/A'}</p>
        <p><strong>Phone:</strong> ${data.phone || 'N/A'}</p>
        <p><strong>Profile Image:</strong> ${data.profileImage ? `<img src="${data.profileImage}" alt="Profile Image" style="width:100px;">` : 'N/A'}</p>
        <p><strong>Created At:</strong> ${formattedCreatedAt}</p>
        <p><strong>Updated At:</strong> ${formattedUpdatedAt}</p>
        <h5>Addresses:</h5>
        ${addressesHtml}
        <h5>Saved Payments:</h5>
        <ul>${paymentsHtml}</ul>
    `;

      fetchUserByIDResult.innerHTML = html;
    } catch (error) {
      fetchUserByIDResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle user purge request
   */
  document.getElementById('purgeUserForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const userIdOrEmail = document.getElementById('purgeUserId').value;
    const purgeUserResult = document.getElementById('purgeUserResult');

    try {
      const purgeResponse = await client.user.purge(userIdOrEmail);
      purgeUserResult.innerHTML = `<p>User purged successfully: ${purgeResponse.data.message}</p>`;
    } catch (error) {
      console.error('Failed to purge user:', error);
      purgeUserResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle address update request
   */
  document.getElementById('updateAddressForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const customerId = document.getElementById('customerId').value;
    const one = document.getElementById('addressOne').value;
    const city = document.getElementById('addressCity').value;
    const state = document.getElementById('addressState').value;
    const isDefault = document.getElementById('isDefaultAddress').checked;
    const updateAddressResult = document.getElementById('updateAddressResult');

    try {
      const addressResponse = await client.user.updateAddress({
        customerId,
        one: NEW_YORK_ADDRESS.one,
        city: NEW_YORK_ADDRESS.city,
        state: NEW_YORK_ADDRESS.state,
        zip: NEW_YORK_ADDRESS.zip,
        type: 'SHIPPING',
        isDefault,
      });
      updateAddressResult.innerHTML = `<p>Address updated/created successfully: ${addressResponse.data.id}</p>`;
    } catch (error) {
      console.error('Failed to update/create address:', error);
      updateAddressResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle address update request with coordinates
   */
  document.getElementById('updateAddressWithCoordsForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const customerId = document.getElementById('customerIdAddress').value;
    const lat = document.getElementById('addressLat').value;
    const long = document.getElementById('addressLong').value;
    const updateAddressResult = document.getElementById('updateAddressWithCoordsResult');

    try {
      const addressResponse = await client.user.updateAddress({
        customerId,
        lat,
        long,
        type: 'SHIPPING',
      });
      updateAddressResult.innerHTML = `<p>Address updated/created successfully: ${addressResponse.data.id}</p>`;
    } catch (error) {
      console.error('Failed to update/create address:', error);
      updateAddressResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle address update request with placesId
   */
  document.getElementById('updateAddressWithPlacesIdForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const customerId = document.getElementById('customerIdAddress').value;
    const placesId = document.getElementById('addressWithPlacesId').value;
    const updateAddressResult = document.getElementById('updateAddressWithCoordsResult');

    try {
      const addressResponse = await client.user.updateAddress({
        customerId,
        placesId,
        type: 'SHIPPING',
      });
      updateAddressResult.innerHTML = `<p>Address updated/created successfully: ${addressResponse.data.id}</p>`;
    } catch (error) {
      console.error('Failed to update/create address:', error);
      updateAddressResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle address purge request
   */
  document.getElementById('purgeAddressForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const addressId = document.getElementById('purgeAddressId').value;
    const purgeAddressResult = document.getElementById('purgeAddressResult');

    try {
      const purgeResponse = await client.user.purgeAddress(addressId);
      purgeAddressResult.innerHTML = `<p>Address purged successfully: ${purgeResponse.data.message}</p>`;
    } catch (error) {
      console.error('Failed to purge address:', error);
      purgeAddressResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  // Payment Method Management

  /**
   * Handle add payment method request
   */
  document.getElementById('addPaymentMethodForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();

    const customerId = document.getElementById('addPaymentCustomerId').value;
    const paymentMethodId = document.getElementById('paymentMethodId').value;
    const isDefault = document.getElementById('isDefault').checked;
    const addPaymentMethodResult = document.getElementById('addPaymentMethodResult');

    try {
      const response = await client.user.addPayment({
        customerId,
        paymentMethodId,
        // comment out to test multiple scenarios
        isDefault,
      });

      addPaymentMethodResult.innerHTML = `
    <p>Payment method added successfully:</p>
    <ul>
      <li>Payment Method ID: ${response.data.id}</li>
      <li>Default: ${response.data.isDefault ? 'Yes' : 'No'}</li>
    </ul>
  `;
    } catch (error) {
      console.error('Failed to add payment method:', error);
      addPaymentMethodResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Update Payment Method Event Listener
   */
  document.getElementById('updatePaymentMethodForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const customerId = document.getElementById('updatePaymentCustomerId').value;
    const paymentMethodId = document.getElementById('updatePaymentMethodId').value;
    const isDefault = document.getElementById('updateIsDefault').checked;
    const updatePaymentMethodResult = document.getElementById('updatePaymentMethodResult');

    try {
      const response = await client.user.updatePayment({
        customerId,
        paymentMethodId,
        // comment out to test multiple scenarios
        isDefault,
      });

      updatePaymentMethodResult.innerHTML = `
          <p>Payment method updated successfully:</p>
          <ul>
            <li>Payment Method ID: ${response.data.id}</li>
            <li>Default: ${response.data.isDefault ? 'Yes' : 'No'}</li>
          </ul>
        `;
    } catch (error) {
      console.error('Failed to update payment method:', error);
      updatePaymentMethodResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle purge payment method request
   */
  document.getElementById('purgePaymentMethodForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();

    const customerId = document.getElementById('purgeCustomerId').value;
    const paymentMethodId = document.getElementById('purgePaymentId').value;
    const purgePaymentMethodResult = document.getElementById('purgePaymentMethodResult');

    try {
      const response = await client.user.purgePayment(customerId, paymentMethodId);

      purgePaymentMethodResult.innerHTML = `
    <p>Payment method purged successfully.</p>
    <ul>
      <li>Deleted: ${response.data.deleted ? 'Yes' : 'No'}</li>
      <li>Message: ${response.data.message}</li>
    </ul>
  `;
    } catch (error) {
      console.error('Failed to purge payment method:', error);
      purgePaymentMethodResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  // Payment Processing

  /**
   * Handle payment form submission
   */
  document.getElementById('paymentForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();

    client = await initSDK();

    const clientSecret = document.getElementById('sessionSecret').value;
    const key = document.getElementById('sessionKey').value;

    // Mount the payment element into the DOM
    try {
      await client.payment.mount({
        clientSecret,
        key,
        elementId: 'payment-element-container',
        appearance: { theme: 'default' },
        elementOptions: { layout: 'tabs' },
      });
      console.log('Payment element mounted');

      client.payment.subscribe('change', ( event ) => {
        console.log('Payment element changed:', event);
      });

      client.payment.subscribe('ready', ( event ) => {
        console.log('Payment element is ready:', event);
      });

    } catch (error) {
      console.error('Failed to mount payment element:', error);
      document.getElementById('paymentTokenResult').innerHTML = `<p class="text-danger">Error mounting payment element: ${error.message}</p>`;
    }
  });

  /**
   * Handle generate payment token request
   */
  document.getElementById('generateTokenButton').addEventListener('click', async () => {
    const paymentTokenResult = document.getElementById('paymentTokenResult');

    try {
      const token = await client.payment.generateToken();
      if (token?.error) {
        paymentTokenResult.innerHTML = `<p class="text-danger">Failed to generate payment token: ${token.error.message}</p>`;
        console.error('Failed to generate payment token:', token.error.message);
      } else {
        paymentTokenResult.innerHTML = `
        <ul>
          <li>Token ID: ${token.id}</li>
          <li>Card Brand: ${token.card?.brand}</li>
          <li>Card Last 4: ${token.card?.last4}</li>
          <li>Expiry: ${token.card?.expMonth}/${token.card?.expYear}</li>
        </ul>
      `;
        console.log('Generated payment token:', token);
      }
    } catch (error) {
      console.error('An unexpected error occurred:', error);
      paymentTokenResult.innerHTML = `<p class="text-danger">Unexpected error: ${error.message}</p>`;
    }
  });

  /**
   * Handle collapse payment element request
   */
  document.getElementById('collapsePaymentButton').addEventListener('click', () => {
    try {
      client.payment.collapse();
      console.log('Payment element collapsed');
    } catch (error) {
      console.error('Failed to collapse payment element:', error);
      document.getElementById('paymentTokenResult').innerHTML = `<p class="text-danger">Error collapsing payment element: ${error.message}</p>`;
    }
  });

  /**
   * Handle unmount payment element request
   */
  document.getElementById('unmountPaymentButton').addEventListener('click', () => {
    try {
      client.payment.unmount();
      console.log('Payment element unmounted');
      document.getElementById('payment-element-container').innerHTML = '';
    } catch (error) {
      console.error('Failed to unmount payment element:', error);
      document.getElementById('paymentTokenResult').innerHTML = `<p class="text-danger">Error unmounting payment element: ${error.message}</p>`;
    }
  });

  /**
   * Handle destroy payment element request
   */
  document.getElementById('destroyPaymentButton').addEventListener('click', () => {
    try {
      client.payment.destroy();
      console.log('Payment element destroyed');
      document.getElementById('payment-element-container').innerHTML = '';
    } catch (error) {
      console.error('Failed to destroy payment element:', error);
      document.getElementById('paymentTokenResult').innerHTML = `<p class="text-danger">Error destroying payment element: ${error.message}</p>`;
    }
  });

  // Checkout Process

  /**
   * Handle checkout form submission
   */
  document.getElementById('checkoutForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();

    const cartId = document.getElementById('checkoutCartId').value;
    const checkoutResults = document.getElementById('checkoutResults');

    // Build the checkout object
    const checkoutData = {
      cartId,
      'recipient': {
        'firstName': 'dioriJoe',
        'lastName': 'John',
        'email': 'john.diori.joe@gmail.com',
        'phone': '9732119920',
        'birthDate': '11-22-1998',
        'hasAgeVerify': true,
      },
      'billingAddress': {
        'firstName': 'NewJoe',
        'lastName': 'NewJohn',
        'email': 'joe.new.john@gmail.com',
        'phone': '1234324987',
        'one': '22 Washington Ave',
        'two': '',
        'city': 'Cliffside Park',
        'state': 'NJ',
        'zip': '07010',
      },
      'hasSubstitutionPolicy': true,
      'isGift': false,
      'billingSameAsShipping': true,
      'giftOptions': {
        'message': '',
        'recipient': {
          'name': '',
          'phone': '',
          'email': '',
        },
      },
      'marketingPreferences': {
        'canEmail': true,
        'canSms': true,
      },
      'deliveryTips': [
        {
          'fulfillmentId': '6570c3ec700628ce1910c105',
          'tip': 2500,
        },
      ],
    };

    try {
      const prepareResponse = await client.checkout.prepare(checkoutData);
      checkoutResults.innerHTML = `
      <h4>Checkout Prepared Successfully</h4>
      <p><strong>Token:</strong> ${prepareResponse.checkout.token}</p>
      <p><strong>Total Amount:</strong> $${(prepareResponse.checkout.amounts.total / 100).toFixed(2)}</p>
      <p><strong>Shipping Address:</strong> ${prepareResponse.checkout.shippingAddress.one}, ${prepareResponse.checkout.shippingAddress.city}, ${prepareResponse.checkout.shippingAddress.state}, ${prepareResponse.checkout.shippingAddress.zip}, ${prepareResponse.checkout.shippingAddress.country}</p>
      <p><strong>Billing Address:</strong> ${prepareResponse.checkout.billingAddress.one}, ${prepareResponse.checkout.billingAddress.city}, ${prepareResponse.checkout.billingAddress.state}, ${prepareResponse.checkout.billingAddress.zip}, ${prepareResponse.checkout.billingAddress.country}</p>
      <h5>Items:</h5>
      <ul>
        ${prepareResponse.checkout.items.map(item => `
          <li>
            <strong>${item.name}</strong> (${item.size}) - $${(item.price / 100).toFixed(2)} x ${item.quantity}
            <br>Fulfillment ID: ${item.fulfillmentId}
            <br>Retailer: ${item.retailerId}
          </li>
        `).join('')}
      </ul>
    `;
    } catch (error) {
      console.error('Failed to prepare checkout:', error);
      checkoutResults.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle complete checkout form submission
   */
  document.getElementById('completeCheckoutForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();

    const completeCheckoutResults = document.getElementById('completeCheckoutResults');

    // Build the complete checkout request object
    const completeCheckoutData = {
      token: document.getElementById('checkoutToken').value,
      payment: document.getElementById('paymentId').value,
    };

    try {
      const completeResponse = await client.checkout.complete(completeCheckoutData);

      // Display the successful response
      completeCheckoutResults.innerHTML = `
    <h4>Checkout Completed Successfully</h4>
    <p><strong>Order Number:</strong> ${completeResponse.order.number}</p>
    <p><strong>Message:</strong> ${completeResponse.message}</p>
  `;
    } catch (error) {
      // Handle the error response
      if (error?.statusCode === 5493) {
        completeCheckoutResults.innerHTML = `
      <h4 class="text-danger">Error Completing Checkout</h4>
      <p><strong>Message:</strong> ${error.message}</p>
    `;
      } else {
        completeCheckoutResults.innerHTML = `<p class="text-danger">An unexpected error occurred: ${error.message}</p>`;
      }
      console.error('Error completing checkout:', error);
    }
  });

  /**
   * Fetch order details based on order ID or number
   * @param {string} identifier - Order ID or number
   */
  async function fetchOrderDetails(identifier) {
    if (!orderClient) {
      document.getElementById('orderResults').innerHTML = '<p class="alert alert-danger">Order SDK not initialized. Please try again.</p>';
      return;
    }

    try {
      const response = await orderClient.order.fetch(identifier);

      if(response.data) {
        displayOrderDetails(response.data);
      } else {
        document.getElementById('orderResults').innerHTML = `
        <div class="alert alert-danger">
          <h5>Order Not Found</h5>
        </div>
      `;
      }

    } catch (error) {
      console.error('Error fetching order details:', error);
      document.getElementById('orderResults').innerHTML = `
      <div class="alert alert-danger">
        <h5>Error Fetching Order</h5>
        <p>${error.message || 'Unknown error occurred'}</p>
      </div>
    `;
    }
  }

  /**
   * Display detailed order information
   * @param {IOrder} order - Order object
   */
  function displayOrderDetails(order) {
    const orderResults = document.getElementById('orderResults');

    // Format dates for display
    const createdDate = new Date(order.createdAt).toLocaleString();
    const updatedDate = new Date(order.updatedAt).toLocaleString();

    // Create HTML content for order details
    let html = `
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Order Details</h4>
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <h5>Order Information</h5>
            <p><strong>Reference ID:</strong> ${order.referenceId || 'N/A'}</p>
            <p><strong>Order Number:</strong> ${order.legacyOrderNumber || 'N/A'}</p>
            <p><strong>Created:</strong> ${createdDate}</p>
            <p><strong>Updated:</strong> ${updatedDate}</p>
            <p><strong>Order Type:</strong> ${order.isHybrid ? 'Hybrid' : 'Standard'}</p>
            ${order.partner && order.partner.id ?
      `<p><strong>Partner ID:</strong> ${order.partner.id}</p>
               <p><strong>Partner Legacy ID:</strong> ${order.partner.legacyId || 'N/A'}</p>` :
      ''}
          </div>
          <div class="col-md-6">
            <h5>Customer Information</h5>
            <p><strong>Name:</strong> ${order.customer.firstName || ''} ${order.customer.lastName || ''}</p>
            <p><strong>Email:</strong> ${order.customer.email}</p>
            <p><strong>Phone:</strong> ${order.customer.phone || 'N/A'}</p>
            <p><strong>Customer ID:</strong> ${order.customer.id}</p>
            ${order.customer.birthdate ? `<p><strong>Birthdate:</strong> ${order.customer.birthdate}</p>` : ''}
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6">
            <h5>Shipping Address</h5>
            ${order.addresses.shipping.firstName || order.addresses.shipping.lastName ?
      `<p>${order.addresses.shipping.firstName || ''} ${order.addresses.shipping.lastName || ''}</p>` : ''}
            ${order.addresses.shipping.company ? `<p>${order.addresses.shipping.company}</p>` : ''}
            <p>${order.addresses.shipping.one}</p>
            ${order.addresses.shipping.two ? `<p>${order.addresses.shipping.two}</p>` : ''}
            <p>${order.addresses.shipping.city}, ${order.addresses.shipping.state} ${order.addresses.shipping.zip}</p>
            <p>${order.addresses.shipping.country}</p>
            <p><strong>Email:</strong> ${order.addresses.shipping.email}</p>
            ${order.addresses.shipping.phone ? `<p><strong>Phone:</strong> ${order.addresses.shipping.phone}</p>` : ''}
          </div>
          <div class="col-md-6">
            <h5>Billing Address</h5>
            ${order.addresses.billing.firstName || order.addresses.billing.lastName ?
      `<p>${order.addresses.billing.firstName || ''} ${order.addresses.billing.lastName || ''}</p>` : ''}
            ${order.addresses.billing.company ? `<p>${order.addresses.billing.company}</p>` : ''}
            <p>${order.addresses.billing.one}</p>
            ${order.addresses.billing.two ? `<p>${order.addresses.billing.two}</p>` : ''}
            <p>${order.addresses.billing.city}, ${order.addresses.billing.state} ${order.addresses.billing.zip}</p>
            <p>${order.addresses.billing.country}</p>
            <p><strong>Email:</strong> ${order.addresses.billing.email}</p>
            ${order.addresses.billing.phone ? `<p><strong>Phone:</strong> ${order.addresses.billing.phone}</p>` : ''}
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6">
            <h5>Order Options</h5>
            <p><strong>Gift Order:</strong> ${order.options.isGift ? 'Yes' : 'No'}</p>
            ${order.options.isGift && order.options.giftMessage ?
      `<p><strong>Gift Message:</strong> ${order.options.giftMessage}</p>` : ''}

            ${order.options.giftRecipient && (order.options.giftRecipient.name || order.options.giftRecipient.email || order.options.giftRecipient.phone) ?
      `<div class="mt-2 mb-2">
                <h6>Gift Recipient</h6>
                ${order.options.giftRecipient.name ? `<p><strong>Name:</strong> ${order.options.giftRecipient.name}</p>` : ''}
                ${order.options.giftRecipient.email ? `<p><strong>Email:</strong> ${order.options.giftRecipient.email}</p>` : ''}
                ${order.options.giftRecipient.phone ? `<p><strong>Phone:</strong> ${order.options.giftRecipient.phone}</p>` : ''}
              </div>` : ''}

            <p><strong>Age Verified:</strong> ${order.options.hasVerifiedAge ? 'Yes' : 'No'}</p>
            <p><strong>Allows Substitution:</strong> ${order.options.allowsSubstitution ? 'Yes' : 'No'}</p>
            <p><strong>Billing Same As Shipping:</strong> ${order.options.billingSameAsShipping ? 'Yes' : 'No'}</p>
            ${order.options.deliveryInstructions ?
      `<p><strong>Delivery Instructions:</strong> ${order.options.deliveryInstructions}</p>` : ''}

            ${order.options.marketingPreferences ?
      `<div class="mt-2">
                <h6>Marketing Preferences</h6>
                <p><strong>Email:</strong> ${order.options.marketingPreferences.email ? 'Opted in' : 'Opted out'}</p>
                <p><strong>SMS:</strong> ${order.options.marketingPreferences.sms ? 'Opted in' : 'Opted out'}</p>
              </div>` : ''}
          </div>
          <div class="col-md-6">
            <h5>Order Totals</h5>
            <p><strong>Subtotal:</strong> $${(order.amounts.subtotal / 100).toFixed(2)}</p>
            <p><strong>Shipping:</strong> $${(order.amounts.shipping / 100).toFixed(2)}</p>
            <p><strong>Platform Fee:</strong> $${(order.amounts.platform / 100).toFixed(2)}</p>
            <p><strong>Tax:</strong> $${(order.amounts.tax / 100).toFixed(2)}</p>
            <p><strong>Engraving Fee:</strong> $${(order.amounts.engraving / 100).toFixed(2)}</p>
            <p><strong>Service Fee:</strong> $${(order.amounts.service / 100).toFixed(2)}</p>
            <p><strong>Delivery Fee:</strong> $${(order.amounts.delivery / 100).toFixed(2)}</p>
            <p><strong>Discounts:</strong> $${(order.amounts.discounts / 100).toFixed(2)}</p>
            <p><strong>Gift Cards:</strong> $${(order.amounts.giftCards / 100).toFixed(2)}</p>
            <p><strong>Tip:</strong> $${(order.amounts.tip / 100).toFixed(2)}</p>
            <p><strong>Total:</strong> <span class="text-primary fw-bold">$${(order.amounts.total / 100).toFixed(2)}</span></p>

            ${order.amounts.taxDetails ?
      `<div class="mt-3">
                <h6>Tax Details</h6>
                <p><strong>Products Tax:</strong> $${(order.amounts.taxDetails.products / 100).toFixed(2)}</p>
                <p><strong>Shipping Tax:</strong> $${(order.amounts.taxDetails.shipping / 100).toFixed(2)}</p>
                <p><strong>Delivery Tax:</strong> $${(order.amounts.taxDetails.delivery / 100).toFixed(2)}</p>
                <p><strong>Bag Tax:</strong> $${(order.amounts.taxDetails.bag / 100).toFixed(2)}</p>
                <p><strong>Bottle Deposits:</strong> $${(order.amounts.taxDetails.bottleDeposits / 100).toFixed(2)}</p>
                <p><strong>Retail Delivery:</strong> $${(order.amounts.taxDetails.retailDelivery / 100).toFixed(2)}</p>
              </div>` : ''}

            ${order.amounts.discountDetails ?
      `<div class="mt-3">
                <h6>Discount Details</h6>
                <p><strong>Products Discount:</strong> $${(order.amounts.discountDetails.products / 100).toFixed(2)}</p>
                <p><strong>Shipping Discount:</strong> $${(order.amounts.discountDetails.shipping / 100).toFixed(2)}</p>
                <p><strong>Delivery Discount:</strong> $${(order.amounts.discountDetails.delivery / 100).toFixed(2)}</p>
                <p><strong>Engraving Discount:</strong> $${(order.amounts.discountDetails.engraving / 100).toFixed(2)}</p>
                <p><strong>Service Discount:</strong> $${(order.amounts.discountDetails.service / 100).toFixed(2)}</p>
              </div>` : ''}
          </div>
        </div>

        ${order.paymentMethods && order.paymentMethods.length > 0 ?
      `<div class="row mb-4">
            <div class="col-12">
              <h5>Payment Methods</h5>
              <div class="table-responsive">
                <table class="table table-striped table-bordered">
                  <thead class="table-dark">
                    <tr>
                      <th>Type</th>
                      <th>Card</th>
                      <th>Last Digits</th>
                      <th>Holder</th>
                      <th>Code</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${order.paymentMethods.map(payment => `
                      <tr>
                        <td>${payment.type || 'N/A'}</td>
                        <td>${payment.card || 'N/A'}</td>
                        <td>${payment.lastDigits || 'N/A'}</td>
                        <td>${payment.holder || 'N/A'}</td>
                        <td>${payment.code || 'N/A'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>` : ''}

        <h5 class="mb-3">Order Items</h5>
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Product</th>
                <th>Retailer</th>
                <th>Size/Details</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${order.items.map(item => {
      // Find retailer for this item
      const retailer = order.retailers.find(r => r.id.toString() === item.retailerId.toString());
      // Find fulfillment for this item
      const fulfillment = item.fulfillmentId ?
        retailer?.fulfillments.find(f => f.id === item.fulfillmentId) : null;

      return `
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        ${item.image ? `<img src="${item.image}" alt="${item.product.name}" class="me-2" style="width: 50px; height: 50px; object-fit: cover;">` : ''}
                        <div>
                          <div class="fw-bold">${item.product.name}</div>
                          <div class="small">${item.product.brand}</div>
                          <div class="small">UPC: ${item.product.upc}</div>
                          <div class="small">SKU: ${item.product.sku}</div>
                          ${item.liquidId ? `<div class="small">Liquid ID: ${item.liquidId}</div>` : ''}
                          ${item.legacyPid ? `<div class="small">Legacy PID: ${item.legacyPid}</div>` : ''}
                        </div>
                      </div>
                    </td>
                    <td>${retailer?.name || 'Unknown'}</td>
                    <td>
                      <div>
                        <p class="mb-1">${item.product.size || 'N/A'}</p>
                        ${item.product.volume ? `<p class="mb-1">Volume: ${item.product.volume}</p>` : ''}
                        ${item.product.uom ? `<p class="mb-1">UOM: ${item.product.uom}</p>` : ''}
                        ${item.product.proof ? `<p class="mb-1">Proof: ${item.product.proof}</p>` : ''}
                        ${item.product.category ? `<p class="mb-1">Category: ${item.product.category}</p>` : ''}
                        ${item.product.attributes.abv ? `<p class="mb-1">ABV: ${item.product.attributes.abv}</p>` : ''}
                        ${item.product.attributes.container ? `<p class="mb-1">Container: ${item.product.attributes.container}</p>` : ''}
                        ${item.product.attributes.containerType ? `<p class="mb-1">Container Type: ${item.product.attributes.containerType}</p>` : ''}
                        ${item.product.attributes.pack ? `<p class="mb-1">Pack: Yes</p>` : ''}
                        ${item.product.attributes.packDescription ? `<p class="mb-1">Pack Description: ${item.product.attributes.packDescription}</p>` : ''}
                        ${item.isPresale ? `<p class="mb-1 text-warning">Pre-sale Item</p>` : ''}
                        ${item.estimatedShipBy ? `<p class="mb-1">Est. Ship By: ${new Date(item.estimatedShipBy).toLocaleDateString()}</p>` : ''}
                        <p class="mb-1">Placement: ${item.customerPlacement}</p>
                      </div>
                    </td>
                    <td>
                      <p class="mb-1">${item.pricing.quantity}</p>
                      ${item.pricing.bottleDeposits > 0 ? `<p class="mb-1">Bottle Deposits: $${(item.pricing.bottleDeposits / 100).toFixed(2)}</p>` : ''}
                    </td>
                    <td>
                      <p class="mb-1">Unit: $${(item.pricing.unitPrice / 100).toFixed(2)}</p>
                      <p class="mb-1">Total: $${(item.pricing.price / 100).toFixed(2)}</p>
                      <p class="mb-1">Tax: $${(item.pricing.tax / 100).toFixed(2)}</p>
                    </td>
                    <td>${fulfillment ? fulfillment.status : 'Processing'}</td>
                  </tr>

                  ${(item.attributes.engraving && item.attributes.engraving.hasEngraving) ||
      (item.attributes.giftCard && (item.attributes.giftCard.sender || item.attributes.giftCard.message || item.attributes.giftCard.recipients.length > 0)) ?
        `<tr>
                    <td colspan="6" class="bg-light">
                      <div class="row">
                        ${item.attributes.engraving && item.attributes.engraving.hasEngraving ?
          `<div class="col-md-6">
                            <h6>Engraving Details</h6>
                            <p><strong>Fee:</strong> $${(item.attributes.engraving.fee / 100).toFixed(2)}</p>
                            ${item.attributes.engraving.location ? `<p><strong>Location:</strong> ${item.attributes.engraving.location}</p>` : ''}
                            ${item.attributes.engraving.lines && item.attributes.engraving.lines.length > 0 ?
            `<p><strong>Lines:</strong></p>
                              <ul>
                                ${item.attributes.engraving.lines.map(line => `<li>${line}</li>`).join('')}
                              </ul>` : ''}
                          </div>` : ''}

                        ${item.attributes.giftCard && (item.attributes.giftCard.sender || item.attributes.giftCard.message || item.attributes.giftCard.recipients.length > 0) ?
          `<div class="col-md-6">
                            <h6>Gift Card Details</h6>
                            ${item.attributes.giftCard.sender ? `<p><strong>Sender:</strong> ${item.attributes.giftCard.sender}</p>` : ''}
                            ${item.attributes.giftCard.message ? `<p><strong>Message:</strong> ${item.attributes.giftCard.message}</p>` : ''}
                            ${item.attributes.giftCard.sendDate ? `<p><strong>Send Date:</strong> ${new Date(item.attributes.giftCard.sendDate).toLocaleDateString()}</p>` : ''}
                            ${item.attributes.giftCard.recipients && item.attributes.giftCard.recipients.length > 0 ?
            `<p><strong>Recipients:</strong></p>
                              <ul>
                                ${item.attributes.giftCard.recipients.map(recipient => `<li>${recipient}</li>`).join('')}
                              </ul>` : ''}
                          </div>` : ''}
                      </div>
                    </td>
                  </tr>` : ''}
                `;
    }).join('')}
            </tbody>
          </table>
        </div>

        ${order.retailers.length > 0 ? `
          <h5 class="mt-4 mb-3">Retailer & Fulfillment Details</h5>
          <div class="accordion" id="retailerAccordion">
            ${order.retailers.map((retailer, index) => `
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading${index}">
                  <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="collapse${index}">
                    <span class="fw-bold">${retailer.name}</span> - ${retailer.system}
                  </button>
                </h2>
                <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="heading${index}" data-bs-parent="#retailerAccordion">
                  <div class="accordion-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6>Retailer Information</h6>
                        <p><strong>ID:</strong> ${retailer.id}</p>
                        ${retailer.legacyId ? `<p><strong>Legacy ID:</strong> ${retailer.legacyId}</p>` : ''}
                        <p><strong>System:</strong> ${retailer.system}</p>
                        <p><strong>Timezone:</strong> ${retailer.timezone}</p>
                      </div>
                      <div class="col-md-6">
                        <h6>Retailer Address</h6>
                        <p>${retailer.address.one}</p>
                        ${retailer.address.two ? `<p>${retailer.address.two}</p>` : ''}
                        <p>${retailer.address.city}, ${retailer.address.state} ${retailer.address.zip}</p>
                        <p>${retailer.address.country}</p>
                        ${retailer.address.coordinates.latitude && retailer.address.coordinates.longitude ?
      `<p><small>Coordinates: ${retailer.address.coordinates.latitude}, ${retailer.address.coordinates.longitude}</small></p>` :
      ''}
                      </div>
                    </div>

                    <div class="row mt-3">
                      <div class="col-md-6">
                        <h6>Retailer Amounts</h6>
                        <p><strong>Subtotal:</strong> $${(retailer.amounts.subtotal / 100).toFixed(2)}</p>
                        <p><strong>Shipping:</strong> $${(retailer.amounts.shipping / 100).toFixed(2)}</p>
                        <p><strong>Platform Fee:</strong> $${(retailer.amounts.platform / 100).toFixed(2)}</p>
                        <p><strong>Tax:</strong> $${(retailer.amounts.tax / 100).toFixed(2)}</p>
                        <p><strong>Engraving Fee:</strong> $${(retailer.amounts.engraving / 100).toFixed(2)}</p>
                        <p><strong>Service Fee:</strong> $${(retailer.amounts.service / 100).toFixed(2)}</p>
                        <p><strong>Delivery Fee:</strong> $${(retailer.amounts.delivery / 100).toFixed(2)}</p>
                        <p><strong>Discounts:</strong> $${(retailer.amounts.discounts / 100).toFixed(2)}</p>
                        <p><strong>Gift Cards:</strong> $${(retailer.amounts.giftCards / 100).toFixed(2)}</p>
                        <p><strong>Tip:</strong> $${(retailer.amounts.tip / 100).toFixed(2)}</p>
                        <p><strong>Total:</strong> <span class="text-primary fw-bold">$${(retailer.amounts.total / 100).toFixed(2)}</span></p>
                      </div>
                    </div>

                    ${retailer.fulfillments.length > 0 ? `
                      <h6 class="mt-3">Fulfillments</h6>
                      <div class="list-group">
                        ${retailer.fulfillments.map(fulfillment => {
      // Get item names for this fulfillment
      const fulfillmentItems = order.items.filter(item =>
        fulfillment.itemIds.includes(item.id.toString()));

      return `
                            <div class="list-group-item">
                              <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Fulfillment ID: ${fulfillment.id}</h6>
                                <span class="badge bg-${getStatusBadgeColor(fulfillment.status)}">${fulfillment.status}</span>
                              </div>
                              <p class="mb-1"><strong>Type:</strong> ${fulfillment.type}</p>
                              <p class="mb-1"><strong>Updated:</strong> ${new Date(fulfillment.updatedAt).toLocaleString()}</p>
                              ${fulfillment.scheduledFor ? `<p class="mb-1"><strong>Scheduled For:</strong> ${new Date(fulfillment.scheduledFor).toLocaleString()}</p>` : ''}

                              <p class="mb-1"><strong>Items:</strong> ${fulfillmentItems.map(item => item.product.name).join(', ')}</p>

                              ${fulfillment.timeline && fulfillment.timeline.length > 0 ? `
                                <h6 class="mt-2 mb-1">Fulfillment Timeline</h6>
                                <ul class="list-unstyled">
                                  ${fulfillment.timeline.map(event => `
                                    <li><small>${new Date(event.timestamp).toLocaleString()} - ${event.status}</small></li>
                                  `).join('')}
                                </ul>
                              ` : ''}

                              ${fulfillment.packages.length > 0 ? `
                                <h6 class="mt-3 mb-2">Packages</h6>
                                <div class="list-group">
                                  ${fulfillment.packages.map(pkg => `
                                    <div class="list-group-item list-group-item-light">
                                      <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">Package ID: ${pkg.id}</h6>
                                        <span class="badge bg-${getPackageStatusBadgeColor(pkg.status)}">${pkg.status}</span>
                                      </div>
                                      ${pkg.carrier ? `<p class="mb-1"><strong>Carrier:</strong> ${pkg.carrier}</p>` : ''}
                                      ${pkg.trackingNumber ? `
                                        <p class="mb-1">
                                          <strong>Tracking:</strong> ${pkg.trackingNumber}
                                          ${pkg.trackingUrl ? `<a href="${pkg.trackingUrl}" target="_blank" class="ms-2">Track Package</a>` : ''}
                                        </p>
                                      ` : ''}
                                      ${pkg.dateShipped ? `<p class="mb-1"><strong>Shipped:</strong> ${new Date(pkg.dateShipped).toLocaleString()}</p>` : ''}

                                      ${pkg.timeline && pkg.timeline.length > 0 ? `
                                        <h6 class="mt-2 mb-1">Package Timeline</h6>
                                        <ul class="list-unstyled">
                                          ${pkg.timeline.map(event => `
                                            <li><small>${new Date(event.timestamp).toLocaleString()} - ${event.status}</small></li>
                                          `).join('')}
                                        </ul>
                                      ` : ''}
                                    </div>
                                  `).join('')}
                                </div>
                              ` : '<p>No packages available.</p>'}
                            </div>
                          `;
    }).join('')}
                      </div>
                    ` : '<p>No fulfillments available.</p>'}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    </div>
  `;

    orderResults.innerHTML = html;
  }

  /**
   * Get Bootstrap badge color class based on order status
   * @param {string} status - Order status
   * @returns {string} Bootstrap color class
   */
  function getStatusBadgeColor(status) {
    switch (status) {
      case 'COMPLETED':
        return 'success';
      case 'PROCESSING':
        return 'primary';
      case 'SHIPPED':
        return 'info';
      case 'DELIVERED':
        return 'success';
      case 'CANCELLED':
        return 'danger';
      case 'RETURNED':
        return 'warning';
      case 'REFUNDED':
        return 'secondary';
      default:
        return 'secondary';
    }
  }

  /**
   * Get Bootstrap badge color class based on package status
   * @param {string} status - Package status
   * @returns {string} Bootstrap color class
   */
  function getPackageStatusBadgeColor(status) {
    switch (status) {
      case 'DELIVERED':
        return 'success';
      case 'IN_TRANSIT':
        return 'info';
      case 'SHIPPED':
        return 'primary';
      case 'LABEL_CREATED':
        return 'secondary';
      case 'EXCEPTION':
        return 'warning';
      case 'CANCELLED':
        return 'danger';
      default:
        return 'secondary';
    }
  }

  const getOrderButton = document.getElementById('getOrder');

  if (getOrderButton) {
    getOrderButton.addEventListener('click', () => {
      const orderId = document.getElementById('orderId').value.trim();
      if (orderId) {
        fetchOrderDetails(orderId);
      } else {
        document.getElementById('orderResults').innerHTML = `
        <div class="alert alert-warning">
          <p>Please enter an Order ID or Order Number.</p>
        </div>
      `;
      }
    });
  }

  document.getElementById('testWebhookButton').addEventListener('click', async () => {
    const webhookEndpoint = document.getElementById('webhookEndpoint').value.trim();
    const webhookTestResult = document.getElementById('webhookTestResult');

    webhookTestResult.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

    try {
      const testResponse = await client.webhook.test(webhookEndpoint);

      if (testResponse) {
        webhookTestResult.innerHTML = '<div class="alert alert-success">' +
          '<strong>Success!</strong> Webhook test request was sent successfully!' +
          (webhookEndpoint ? ' to: ' + webhookEndpoint : ' to your default endpoint.') +
          '</div>';
      } else {
        webhookTestResult.innerHTML = '<div class="alert alert-warning">' +
          '<strong>Warning!</strong> Webhook test request failed. Please check your configuration.' +
          '</div>';
      }
    } catch (error) {
      console.error('Error testing webhook:', error);
      webhookTestResult.innerHTML = `<div class="alert alert-danger"><strong>Error!</strong> ${error.message}</div>`;
    }
  });

  /**
   * Create Payment Session
   */
  document.getElementById('createPaymentSessionForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    const cartId = document.getElementById('paymentSessionCartId').value;
    const checkoutToken = document.getElementById('paymentSessionCheckoutToken').value;
    const customerId = document.getElementById('paymentSessionCustomerId').value;
    const customerEmail = document.getElementById('paymentSessionCustomerEmail').value;
    const paymentSessionResult = document.getElementById('paymentSessionResult');

    const params = {};
    if (cartId) params.cartId = cartId;
    if (checkoutToken) params.checkoutToken = checkoutToken;
    if (customerId) params.customerId = customerId;
    if (customerEmail) params.customerEmail = customerEmail;

    try {
      const response = await client.user.paymentSession(params);
      let html = '<h4>Payment Session Created</h4>';
      html += `<div class="session-detail"><strong>Key:</strong> ${response.data.key}</div>`;
      html += `<div class="session-detail"><strong>Secret:</strong> ${response.data.secret}</div>`;
      html += `<p><strong>Created At:</strong> ${new Date(response.data.createdAt).toLocaleString()}</p>`;
      if (response.metadata) {
        html += '<h5>Metadata:</h5>';
        html += `<p>Request ID: ${response.metadata.requestId}</p>`;
        html += `<p>Timestamp: ${new Date(response.metadata.timestamp).toLocaleString()}</p>`;
      }
      paymentSessionResult.innerHTML = html;
    } catch (error) {
      console.error('Failed to create payment session:', error);
      paymentSessionResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle user purge request
   */
  document.getElementById('purgeUserForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const userIdOrEmail = document.getElementById('purgeUserId').value;
    const purgeUserResult = document.getElementById('purgeUserResult');

    try {
      const purgeResponse = await client.user.purge(userIdOrEmail);
      purgeUserResult.innerHTML = `<p>User purged successfully: ${purgeResponse.data.message}</p>`;
    } catch (error) {
      console.error('Failed to purge user:', error);
      purgeUserResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle address update request
   */
  document.getElementById('updateAddressForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const customerId = document.getElementById('customerId').value;
    const one = document.getElementById('addressOne').value;
    const city = document.getElementById('addressCity').value;
    const state = document.getElementById('addressState').value;
    const isDefault = document.getElementById('isDefaultAddress').checked;
    const updateAddressResult = document.getElementById('updateAddressResult');

    try {
      const addressResponse = await client.user.updateAddress({
        customerId,
        one: NEW_YORK_ADDRESS.one,
        city: NEW_YORK_ADDRESS.city,
        state: NEW_YORK_ADDRESS.state,
        zip: NEW_YORK_ADDRESS.zip,
        type: 'SHIPPING',
        isDefault,
      });
      updateAddressResult.innerHTML = `<p>Address updated/created successfully: ${addressResponse.data.id}</p>`;
    } catch (error) {
      console.error('Failed to update/create address:', error);
      updateAddressResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle address update request with coordinates
   */
  document.getElementById('updateAddressWithCoordsForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const customerId = document.getElementById('customerIdAddress').value;
    const lat = document.getElementById('addressLat').value;
    const long = document.getElementById('addressLong').value;
    const updateAddressResult = document.getElementById('updateAddressWithCoordsResult');

    try {
      const addressResponse = await client.user.updateAddress({
        customerId,
        lat,
        long,
        type: 'SHIPPING',
      });
      updateAddressResult.innerHTML = `<p>Address updated/created successfully: ${addressResponse.data.id}</p>`;
    } catch (error) {
      console.error('Failed to update/create address:', error);
      updateAddressResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle address update request with placesId
   */
  document.getElementById('updateAddressWithPlacesIdForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const customerId = document.getElementById('customerIdAddress').value;
    const placesId = document.getElementById('addressWithPlacesId').value;
    const updateAddressResult = document.getElementById('updateAddressWithCoordsResult');

    try {
      const addressResponse = await client.user.updateAddress({
        customerId,
        placesId,
        type: 'SHIPPING',
      });
      updateAddressResult.innerHTML = `<p>Address updated/created successfully: ${addressResponse.data.id}</p>`;
    } catch (error) {
      console.error('Failed to update/create address:', error);
      updateAddressResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle address purge request
   */
  document.getElementById('purgeAddressForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const addressId = document.getElementById('purgeAddressId').value;
    const purgeAddressResult = document.getElementById('purgeAddressResult');

    try {
      const purgeResponse = await client.user.purgeAddress(addressId);
      purgeAddressResult.innerHTML = `<p>Address purged successfully: ${purgeResponse.data.message}</p>`;
    } catch (error) {
      console.error('Failed to purge address:', error);
      purgeAddressResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  // Payment Method Management

  /**
   * Handle add payment method request
   */
  document.getElementById('addPaymentMethodForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();

    const customerId = document.getElementById('addPaymentCustomerId').value;
    const paymentMethodId = document.getElementById('paymentMethodId').value;
    const isDefault = document.getElementById('isDefault').checked;
    const addPaymentMethodResult = document.getElementById('addPaymentMethodResult');

    try {
      const response = await client.user.addPayment({
        customerId,
        paymentMethodId,
        // comment out to test multiple scenarios
        isDefault,
      });

      addPaymentMethodResult.innerHTML = `
    <p>Payment method added successfully:</p>
    <ul>
      <li>Payment Method ID: ${response.data.id}</li>
      <li>Default: ${response.data.isDefault ? 'Yes' : 'No'}</li>
    </ul>
  `;
    } catch (error) {
      console.error('Failed to add payment method:', error);
      addPaymentMethodResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Update Payment Method Event Listener
   */
  document.getElementById('updatePaymentMethodForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();
    const customerId = document.getElementById('updatePaymentCustomerId').value;
    const paymentMethodId = document.getElementById('updatePaymentMethodId').value;
    const isDefault = document.getElementById('updateIsDefault').checked;
    const updatePaymentMethodResult = document.getElementById('updatePaymentMethodResult');

    try {
      const response = await client.user.updatePayment({
        customerId,
        paymentMethodId,
        // comment out to test multiple scenarios
        isDefault,
      });

      updatePaymentMethodResult.innerHTML = `
          <p>Payment method updated successfully:</p>
          <ul>
            <li>Payment Method ID: ${response.data.id}</li>
            <li>Default: ${response.data.isDefault ? 'Yes' : 'No'}</li>
          </ul>
        `;
    } catch (error) {
      console.error('Failed to update payment method:', error);
      updatePaymentMethodResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle purge payment method request
   */
  document.getElementById('purgePaymentMethodForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();

    const customerId = document.getElementById('purgeCustomerId').value;
    const paymentMethodId = document.getElementById('purgePaymentId').value;
    const purgePaymentMethodResult = document.getElementById('purgePaymentMethodResult');

    try {
      const response = await client.user.purgePayment(customerId, paymentMethodId);

      purgePaymentMethodResult.innerHTML = `
    <p>Payment method purged successfully.</p>
    <ul>
      <li>Deleted: ${response.data.deleted ? 'Yes' : 'No'}</li>
      <li>Message: ${response.data.message}</li>
    </ul>
  `;
    } catch (error) {
      console.error('Failed to purge payment method:', error);
      purgePaymentMethodResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  // Payment Processing

  /**
   * Handle payment form submission
   */
  document.getElementById('paymentForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();

    client = await initSDK();

    const clientSecret = document.getElementById('sessionSecret').value;
    const key = document.getElementById('sessionKey').value;

    // Mount the payment element into the DOM
    try {
      await client.payment.mount({
        clientSecret,
        key,
        elementId: 'payment-element-container',
        appearance: { theme: 'default' },
        elementOptions: { layout: 'tabs' },
      });
      console.log('Payment element mounted');

      client.payment.subscribe('change', ( event ) => {
        console.log('Payment element changed:', event);
      });

      client.payment.subscribe('ready', ( event ) => {
        console.log('Payment element is ready:', event);
      });

    } catch (error) {
      console.error('Failed to mount payment element:', error);
      document.getElementById('paymentTokenResult').innerHTML = `<p class="text-danger">Error mounting payment element: ${error.message}</p>`;
    }
  });

  /**
   * Handle generate payment token request
   */
  document.getElementById('generateTokenButton').addEventListener('click', async () => {
    const paymentTokenResult = document.getElementById('paymentTokenResult');

    try {
      const token = await client.payment.generateToken();
      if (token?.error) {
        paymentTokenResult.innerHTML = `<p class="text-danger">Failed to generate payment token: ${token.error.message}</p>`;
        console.error('Failed to generate payment token:', token.error.message);
      } else {
        paymentTokenResult.innerHTML = `
        <ul>
          <li>Token ID: ${token.id}</li>
          <li>Card Brand: ${token.card?.brand}</li>
          <li>Card Last 4: ${token.card?.last4}</li>
          <li>Expiry: ${token.card?.expMonth}/${token.card?.expYear}</li>
        </ul>
      `;
        console.log('Generated payment token:', token);
      }
    } catch (error) {
      console.error('An unexpected error occurred:', error);
      paymentTokenResult.innerHTML = `<p class="text-danger">Unexpected error: ${error.message}</p>`;
    }
  });

  /**
   * Handle collapse payment element request
   */
  document.getElementById('collapsePaymentButton').addEventListener('click', () => {
    try {
      client.payment.collapse();
      console.log('Payment element collapsed');
    } catch (error) {
      console.error('Failed to collapse payment element:', error);
      document.getElementById('paymentTokenResult').innerHTML = `<p class="text-danger">Error collapsing payment element: ${error.message}</p>`;
    }
  });

  /**
   * Handle unmount payment element request
   */
  document.getElementById('unmountPaymentButton').addEventListener('click', () => {
    try {
      client.payment.unmount();
      console.log('Payment element unmounted');
      document.getElementById('payment-element-container').innerHTML = '';
    } catch (error) {
      console.error('Failed to unmount payment element:', error);
      document.getElementById('paymentTokenResult').innerHTML = `<p class="text-danger">Error unmounting payment element: ${error.message}</p>`;
    }
  });

  /**
   * Handle destroy payment element request
   */
  document.getElementById('destroyPaymentButton').addEventListener('click', () => {
    try {
      client.payment.destroy();
      console.log('Payment element destroyed');
      document.getElementById('payment-element-container').innerHTML = '';
    } catch (error) {
      console.error('Failed to destroy payment element:', error);
      document.getElementById('paymentTokenResult').innerHTML = `<p class="text-danger">Error destroying payment element: ${error.message}</p>`;
    }
  });

  /**
   * Handle Auth Details Request
   */
  document.getElementById('getAuthDetails').addEventListener('click', async () => {
    const authResult = document.getElementById('authResult');
    try {
      const authResponse = await client.auth();

      let html = '<h4>Auth Details</h4>';
      // Corrected property names based on the API response
      html += `<div class="session-detail"><strong>Access Token:</strong> ${authResponse.token}</div>`;
      html += `<p><strong>Expires In (Timestamp):</strong> ${authResponse.exp}</p>`;
      html += `<p><strong>Token Type:</strong> ${authResponse.type}</p>`;
      authResult.innerHTML = html;
    } catch (error) {
      console.error('Failed to get auth details:', error);
      authResult.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  /**
   * Handle checkout form submission
   */
  document.getElementById('checkoutForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();

    const cartId = document.getElementById('checkoutCartId').value;
    const checkoutResults = document.getElementById('checkoutResults');

    // Build the checkout object
    const checkoutData = {
      cartId,
      'recipient': {
        'firstName': 'dioriJoe',
        'lastName': 'John',
        'email': 'john.diori.joe@gmail.com',
        'phone': '9732119920',
        'birthDate': '11-22-1998',
        'hasAgeVerify': true,
      },
      'billingAddress': {
        'firstName': 'NewJoe',
        'lastName': 'NewJohn',
        'email': 'joe.new.john@gmail.com',
        'phone': '1234324987',
        'one': '22 Washington Ave',
        'two': '',
        'city': 'Cliffside Park',
        'state': 'NJ',
        'zip': '07010',
      },
      'hasSubstitutionPolicy': true,
      'isGift': false,
      'billingSameAsShipping': true,
      'giftOptions': {
        'message': '',
        'recipient': {
          'name': '',
          'phone': '',
          'email': '',
        },
      },
      'marketingPreferences': {
        'canEmail': true,
        'canSms': true,
      },
      'deliveryTips': [
        {
          'fulfillmentId': '6570c3ec700628ce1910c105',
          'tip': 2500,
        },
      ],
    };

    try {
      const prepareResponse = await client.checkout.prepare(checkoutData);
      checkoutResults.innerHTML = `
      <h4>Checkout Prepared Successfully</h4>
      <p><strong>Token:</strong> ${prepareResponse.checkout.token}</p>
      <p><strong>Total Amount:</strong> $${(prepareResponse.checkout.amounts.total / 100).toFixed(2)}</p>
      <p><strong>Shipping Address:</strong> ${prepareResponse.checkout.shippingAddress.one}, ${prepareResponse.checkout.shippingAddress.city}, ${prepareResponse.checkout.shippingAddress.state}, ${prepareResponse.checkout.shippingAddress.zip}, ${prepareResponse.checkout.shippingAddress.country}</p>
      <p><strong>Billing Address:</strong> ${prepareResponse.checkout.billingAddress.one}, ${prepareResponse.checkout.billingAddress.city}, ${prepareResponse.checkout.billingAddress.state}, ${prepareResponse.checkout.billingAddress.zip}, ${prepareResponse.checkout.billingAddress.country}</p>
      <h5>Items:</h5>
      <ul>
        ${prepareResponse.checkout.items.map(item => `
          <li>
            <strong>${item.name}</strong> (${item.size}) - $${(item.price / 100).toFixed(2)} x ${item.quantity}
            <br>Fulfillment ID: ${item.fulfillmentId}
            <br>Retailer: ${item.retailerId}
          </li>
        `).join('')}
      </ul>
    `;
    } catch (error) {
      console.error('Failed to prepare checkout:', error);
      checkoutResults.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  // --- Payment Element V2 Logic ---
  const peV2CreatePaymentSessionForm = document.getElementById('peV2CreatePaymentSessionForm');
  const peV2PaymentSessionResultDiv = document.getElementById('peV2PaymentSessionResult');
  const peV2SessionKeySpan = document.getElementById('peV2SessionKey');
  const peV2SessionSecretSpan = document.getElementById('peV2SessionSecret');
  const peV2SessionCreatedAtSpan = document.getElementById('peV2SessionCreatedAt');
  const mountPeV2Button = document.getElementById('mountPeV2Button');
  const peV2ElementIdInput = document.getElementById('peV2ElementId');
  const peV2AppearanceThemeSelect = document.getElementById('peV2AppearanceTheme');
  const peV2LayoutSelect = document.getElementById('peV2Layout');
  const peV2InteractionResultDiv = document.getElementById('peV2InteractionResult');
  const createPeV2ConfirmationTokenButton = document.getElementById('createPeV2ConfirmationTokenButton');
  const collapsePeV2Button = document.getElementById('collapsePeV2Button');
  const unmountPeV2Button = document.getElementById('unmountPeV2Button');
  const destroyPeV2Button = document.getElementById('destroyPeV2Button');
  const peV2EventLogDiv = document.getElementById('peV2EventLog');

  const peV2EventSwitches = {
    ready: document.getElementById('subscribeToPeV2ReadyEvent'),
    change: document.getElementById('subscribeToPeV2ChangeEvent'),
    focus: document.getElementById('subscribeToPeV2FocusEvent'),
    blur: document.getElementById('subscribeToPeV2BlurEvent'),
    loaderror: document.getElementById('subscribeToPeV2LoadErrorEvent'),
    loaderstart: document.getElementById('subscribeToPeV2LoaderStartEvent'),
  };

  function logPeV2Event(eventName, eventData) {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `<small><strong>[${timestamp}] ${eventName}:</strong> ${JSON.stringify(eventData, null, 2)}</small>`;
    if (peV2EventLogDiv.firstChild && peV2EventLogDiv.firstChild.textContent === 'Event logs will appear here...') {
        peV2EventLogDiv.innerHTML = ''; // Clear initial message
    }
    peV2EventLogDiv.appendChild(logEntry);
    peV2EventLogDiv.scrollTop = peV2EventLogDiv.scrollHeight; // Scroll to bottom
  }

  const peV2EventHandlers = {
    ready: (event) => logPeV2Event('ready', event),
    change: (event) => logPeV2Event('change', event),
    focus: (event) => logPeV2Event('focus', event),
    blur: (event) => logPeV2Event('blur', event),
    loaderror: (event) => logPeV2Event('loaderror', event),
    loaderstart: (event) => logPeV2Event('loaderstart', event),
  };

  peV2CreatePaymentSessionForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const cartId = document.getElementById('peV2PaymentSessionCartId').value;
    const checkoutToken = document.getElementById('peV2PaymentSessionCheckoutToken').value;
    const customerId = document.getElementById('peV2PaymentSessionCustomerId').value;
    const customerEmail = document.getElementById('peV2PaymentSessionCustomerEmail').value;

    const params = {};
    if (cartId) params.cartId = cartId;
    if (checkoutToken) params.checkoutToken = checkoutToken;
    if (customerId) params.customerId = customerId;
    if (customerEmail) params.customerEmail = customerEmail;

    try {
      const response = await client.user.paymentSession(params);
      peV2SessionData = response.data; // Store key, secret, createdAt
      peV2SessionKeySpan.textContent = peV2SessionData.key;
      peV2SessionSecretSpan.textContent = peV2SessionData.secret;
      peV2SessionCreatedAtSpan.textContent = new Date(peV2SessionData.createdAt).toLocaleString();
      peV2PaymentSessionResultDiv.style.display = 'block';
      mountPeV2Button.disabled = false;
      peV2InteractionResultDiv.innerHTML = '<small><em>Session created. Ready to mount element.</em></small>';
    } catch (error) {
      console.error('Failed to create payment session for V2 element:', error);
      peV2InteractionResultDiv.innerHTML = `<p class="text-danger">Error creating session: ${error.message}</p>`;
      mountPeV2Button.disabled = true;
    }
  });

  mountPeV2Button.addEventListener('click', async () => {
    if (!peV2SessionData || !peV2SessionData.key || !peV2SessionData.secret) {
      peV2InteractionResultDiv.innerHTML = '<p class="text-danger">Payment session data is missing. Create a session first.</p>';
      return;
    }
    const elementId = peV2ElementIdInput.value.trim();
    if (!elementId) {
      peV2InteractionResultDiv.innerHTML = '<p class="text-danger">Target Element ID is required.</p>';
      return;
    }
     // Ensure the container is empty before mounting
    document.getElementById(elementId).innerHTML = '';


    const appearanceTheme = peV2AppearanceThemeSelect.value;
    const layout = peV2LayoutSelect.value;

    try {
      // Instantiate the Payment Element V2
      // The factory function `LiquidCommercePaymentElement` takes the full config for constructor
      // but the `mount` method itself also takes a config.
      // Based on `cloud-sdk/src/liquid-commerce-payment-element.ts`, the constructor needs session.
      // The `mount` method then also needs elementId, appearance, elementOptions.

      const elementConfigForConstructor = {
        session: { // This is IUserSession: { key, secret, createdAt }
          key: peV2SessionData.key,
          secret: peV2SessionData.secret,
          createdAt: new Date(peV2SessionData.createdAt) // Ensure it's a Date object
        },
        // elementId is NOT part of constructor config based on IPaymentElementConfig in payment-element.interface.ts for the constructor
        // but seems to be for the mount method.
      };
       // The factory function initializes with a config, let's align with what IPaymentElementConfig suggests for constructor.
      // It seems the `options` in `LiquidCommercePaymentElement(options: IPaymentElementConfig)` is the full config.
      // Let's try passing the full mount config directly to the factory.
       const fullMountConfig = {
        session: {
          key: peV2SessionData.key,
          secret: peV2SessionData.secret,
          createdAt: new Date(peV2SessionData.createdAt)
        },
        elementId: elementId,
        appearance: { theme: appearanceTheme },
        elementOptions: { layout: layout }
      };

      paymentElementV2 = LiquidCommercePaymentElement(fullMountConfig);


      // Now call mount with the same config or a subset as needed.
      // The ILiquidCommercePaymentElement interface's mount method takes IPaymentElementConfig.
      await paymentElementV2.mount(fullMountConfig);

      peV2InteractionResultDiv.innerHTML = '<p class="text-success">Payment Element V2 mounted successfully!</p>';
      // Enable interaction buttons
      createPeV2ConfirmationTokenButton.disabled = false;
      collapsePeV2Button.disabled = false;
      unmountPeV2Button.disabled = false;
      destroyPeV2Button.disabled = false;
      mountPeV2Button.textContent = 'Re-Mount Element'; // Change button text

      // Handle subscriptions based on switches
      Object.keys(peV2EventSwitches).forEach(key => {
        if (peV2EventSwitches[key].checked) {
          paymentElementV2.subscribe(key, peV2EventHandlers[key]);
        }
        peV2EventSwitches[key].onchange = (e) => {
          if (paymentElementV2) { // Check if element is initialized
            if (e.target.checked) {
              paymentElementV2.subscribe(key, peV2EventHandlers[key]);
              logPeV2Event(key, { subscribed: true });
            } else {
              paymentElementV2.unsubscribe(key, peV2EventHandlers[key]);
              logPeV2Event(key, { unsubscribed: true });
            }
          }
        };
      });

    } catch (error) {
      console.error('Failed to mount Payment Element V2:', error);
      peV2InteractionResultDiv.innerHTML = `<p class="text-danger">Error mounting element: ${error.message}</p>`;
    }
  });

  createPeV2ConfirmationTokenButton.addEventListener('click', async () => {
    if (!paymentElementV2) {
      peV2InteractionResultDiv.innerHTML = '<p class="text-danger">Element not mounted.</p>';
      return;
    }
    try {
      // Example: provide a return_url if needed for your payment flow.
      // const params = { returnUrl: window.location.href };
      const tokenResponse = await paymentElementV2.createConfirmationToken(/* params */);
      if (tokenResponse.id) {
        peV2InteractionResultDiv.innerHTML = `<p class="text-success">Confirmation Token: ${tokenResponse.id}</p>`;
      } else { // ILiquidPaymentError
        peV2InteractionResultDiv.innerHTML = `<p class="text-danger">Error creating token: ${tokenResponse.message} (Code: ${tokenResponse.code})</p>`;
      }
    } catch (error) {
      console.error('Error creating confirmation token:', error);
      peV2InteractionResultDiv.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  collapsePeV2Button.addEventListener('click', () => {
    if (!paymentElementV2) {
      peV2InteractionResultDiv.innerHTML = '<p class="text-danger">Element not mounted.</p>';
      return;
    }
    try {
      paymentElementV2.collapse();
      peV2InteractionResultDiv.innerHTML = '<p class="text-info">Collapse called. (Note: Actual collapse depends on provider and element state)</p>';
    } catch (error) {
      console.error('Error collapsing element:', error);
      peV2InteractionResultDiv.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  unmountPeV2Button.addEventListener('click', () => {
    if (!paymentElementV2) {
      peV2InteractionResultDiv.innerHTML = '<p class="text-danger">Element not mounted or already unmounted.</p>';
      return;
    }
    try {
      paymentElementV2.unmount();
      peV2InteractionResultDiv.innerHTML = '<p class="text-warning">Payment Element V2 unmounted.</p>';
      // Disable most interaction buttons, allow re-mount or destroy
      createPeV2ConfirmationTokenButton.disabled = true;
      collapsePeV2Button.disabled = true;
      unmountPeV2Button.disabled = true;
      // Keep mountPeV2Button enabled for re-mounting
      // Keep destroyPeV2Button enabled
    } catch (error) {
      console.error('Error unmounting element:', error);
      peV2InteractionResultDiv.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

  destroyPeV2Button.addEventListener('click', () => {
    if (!paymentElementV2) {
      peV2InteractionResultDiv.innerHTML = '<p class="text-danger">Element not available to destroy.</p>';
      return;
    }
    try {
      paymentElementV2.destroy();
      peV2InteractionResultDiv.innerHTML = '<p class="text-danger">Payment Element V2 destroyed.</p>';
      // Disable all interaction buttons
      mountPeV2Button.disabled = false; // Allow creating a new session and mounting again.
      mountPeV2Button.textContent = 'Mount Element';
      createPeV2ConfirmationTokenButton.disabled = true;
      collapsePeV2Button.disabled = true;
      unmountPeV2Button.disabled = true;
      destroyPeV2Button.disabled = true;
      paymentElementV2 = null; // Clear the instance
      peV2SessionData = null; // Clear session data as well
      peV2PaymentSessionResultDiv.style.display = 'none';


    } catch (error) {
      console.error('Error destroying element:', error);
      peV2InteractionResultDiv.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });


  /**
   * Handle checkout form submission
   */
  document.getElementById('checkoutForm').addEventListener('submit', async ( event ) => {
    event.preventDefault();

    const cartId = document.getElementById('checkoutCartId').value;
    const checkoutResults = document.getElementById('checkoutResults');

    // Build the checkout object
    const checkoutData = {
      cartId,
      'recipient': {
        'firstName': 'dioriJoe',
        'lastName': 'John',
        'email': 'john.diori.joe@gmail.com',
        'phone': '9732119920',
        'birthDate': '11-22-1998',
        'hasAgeVerify': true,
      },
      'billingAddress': {
        'firstName': 'NewJoe',
        'lastName': 'NewJohn',
        'email': 'joe.new.john@gmail.com',
        'phone': '1234324987',
        'one': '22 Washington Ave',
        'two': '',
        'city': 'Cliffside Park',
        'state': 'NJ',
        'zip': '07010',
      },
      'hasSubstitutionPolicy': true,
      'isGift': false,
      'billingSameAsShipping': true,
      'giftOptions': {
        'message': '',
        'recipient': {
          'name': '',
          'phone': '',
          'email': '',
        },
      },
      'marketingPreferences': {
        'canEmail': true,
        'canSms': true,
      },
      'deliveryTips': [
        {
          'fulfillmentId': '6570c3ec700628ce1910c105',
          'tip': 2500,
        },
      ],
    };

    try {
      const prepareResponse = await client.checkout.prepare(checkoutData);
      checkoutResults.innerHTML = `
      <h4>Checkout Prepared Successfully</h4>
      <p><strong>Token:</strong> ${prepareResponse.checkout.token}</p>
      <p><strong>Total Amount:</strong> $${(prepareResponse.checkout.amounts.total / 100).toFixed(2)}</p>
      <p><strong>Shipping Address:</strong> ${prepareResponse.checkout.shippingAddress.one}, ${prepareResponse.checkout.shippingAddress.city}, ${prepareResponse.checkout.shippingAddress.state}, ${prepareResponse.checkout.shippingAddress.zip}, ${prepareResponse.checkout.shippingAddress.country}</p>
      <p><strong>Billing Address:</strong> ${prepareResponse.checkout.billingAddress.one}, ${prepareResponse.checkout.billingAddress.city}, ${prepareResponse.checkout.billingAddress.state}, ${prepareResponse.checkout.billingAddress.zip}, ${prepareResponse.checkout.billingAddress.country}</p>
      <h5>Items:</h5>
      <ul>
        ${prepareResponse.checkout.items.map(item => `
          <li>
            <strong>${item.name}</strong> (${item.size}) - $${(item.price / 100).toFixed(2)} x ${item.quantity}
            <br>Fulfillment ID: ${item.fulfillmentId}
            <br>Retailer: ${item.retailerId}
          </li>
        `).join('')}
      </ul>
    `;
    } catch (error) {
      console.error('Failed to prepare checkout:', error);
      checkoutResults.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
  });

</script>
</body>
</html>